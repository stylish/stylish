'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.develop = develop;
exports.handle = handle;
exports.launchWatcher = launchWatcher;
exports.launchServer = launchServer;
exports.launchTunnel = launchTunnel;

var _path = require('path');

var _shelljs = require('shelljs');

var _shelljs2 = _interopRequireDefault(_shelljs);

var _util = require('../util');

var _util2 = _interopRequireDefault(_util);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function develop(program, dispatch) {
  program.command('dev [entry]').alias('develop').alias('dev-server').description('run a development server for this project').option('--port <port>', 'which port should this server listen on?', 3000).option('--host <hostname>', 'which hostname should this server listen on?', 'localhost').option('--entry <path>', 'relative path to the entry point', './src').option('--entry-name <name>', 'what to name the entry point script', 'app').option('--platform <name>', 'which platform are we building for? electron or web', 'web').option('--theme <name>', 'the name of the theme to use').option('--html-template-path <path>', 'path to the html template to use').option('--precompiled <name>', 'use a precompiled html template which includes vendor libs, themes, etc').option('--ngrok', 'when enabled, will attempt to use ngrok to expose a public API endpoint for this server').option('--ngrok-config <path>', 'path to a configuration file for the ngrok service').option('--silent', 'suppress any server output').option('--debug', 'show error info from the server').option('--dev-tools-path <path>', 'path to the skypager-devpack devtools library').option('--webpack-config <path>', 'path to a javascript function which can mutate the webpack config').option('--bundle', 'watch for content changes in the project and update the distribution bundle').option('--bundle-command', 'the command to run to generate the bundle default: skypager export bundle', 'skypager export bundle').option('--middleware <path>', 'apply express middleware to the dev-server').option('--modules-path <path>', 'which modules folder to use for webpacks default? defaults to standard node_modules').option('--feature-flags <path>', 'path to a script which exports an object to be used for feature flags').option('--skip-theme', 'do not include a theme').option('--entry-only', 'do not use html template').option('--dist-path <path>', 'the project exporter or dist path').option('--external-vendors', "assume vendor libraries will be available to our script").option('--no-vendor-libraries', "don't include any vendor libraries in the bundle").option('--export-library <name>', 'build this as a umd library').action(dispatch(handle));
}

exports.default = develop;
function handle(entry) {
  var options = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  var context = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];

  var project = context.project;

  launchWatcher(options, context);

  launchServer(entry, options, context);

  if (options.ngrok) {
    launchTunnel(options, context);
  }
}

function launchWatcher(options, context) {
  var project = context.project;

  var bundleCommand = options.bundleCommand || 'skypager export bundle';

  console.log('Exporting project bundle'.green);
  _shelljs2.default.exec(bundleCommand + ' --clean');

  console.log('Launching project bundler'.yellow);
  var proc = _shelljs2.default.exec('chokidar \'./{data,docs}/**/*.*\' --silent --ignore --debounce 1200 -c \'' + bundleCommand + '\'', { async: true });

  proc.stdout.on('data', function (data) {
    if (!options.silent) {
      console.log(data);
    }
  });

  proc.stderr.on('data', function (data) {
    if (options.debug) {
      console.log(data);
    }
  });
}

function launchServer(entry) {
  var options = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  var context = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];

  var project = context.project;

  options.entry = entry || options.entry || project.options.entry || './src';
  options.theme = options.theme || project.options.theme || 'marketing';

  options.staticAssets = options.staticAssets || project.options.staticAssets || {};

  console.log('Launching server'.cyan);
  process.env.NODE_ENV = 'development';
  require(pathToDevpack(options.devToolsPath) + '/webpack/server')(options);
}

function launchTunnel(options, context) {
  var server = _shelljs2.default.exec('ngrok http ' + (options.port || 3000), { async: true });

  console.log(server);

  server.stdout.on('data', function (data) {
    console.log(data);
  });

  server.stderr.on('data', function (data) {
    console.log(data);
  });

  server.on('end', function () {
    console.log('Ngrok tunnel ended');
  });
}

function pathToDevpack(opt) {
  return opt && (0, _path.resolve)(opt) || process.env.SKYPAGER_DEVPACK_PATH || (0, _path.dirname)(require.resolve('skypager-devpack'));
}

function isDepackInstalled() {
  try {
    return pathToDevpack();
  } catch (error) {
    return false;
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21tYW5kcy9kZXZlbG9wLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O1FBS2dCLE9BQU8sR0FBUCxPQUFPO1FBb0NQLE1BQU0sR0FBTixNQUFNO1FBWU4sYUFBYSxHQUFiLGFBQWE7UUF3QmIsWUFBWSxHQUFaLFlBQVk7UUFhWixZQUFZLEdBQVosWUFBWTs7Ozs7Ozs7Ozs7Ozs7QUFyRnJCLFNBQVMsT0FBTyxDQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUU7QUFDMUMsU0FBTyxDQUNKLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FDdEIsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUNoQixLQUFLLENBQUMsWUFBWSxDQUFDLENBQ25CLFdBQVcsQ0FBQywyQ0FBMkMsQ0FBQyxDQUN4RCxNQUFNLENBQUMsZUFBZSxFQUFFLDBDQUEwQyxFQUFFLElBQUksQ0FBQyxDQUN6RSxNQUFNLENBQUMsbUJBQW1CLEVBQUUsOENBQThDLEVBQUUsV0FBVyxDQUFDLENBQ3hGLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxrQ0FBa0MsRUFBRSxPQUFPLENBQUMsQ0FDckUsTUFBTSxDQUFDLHFCQUFxQixFQUFFLHFDQUFxQyxFQUFFLEtBQUssQ0FBQyxDQUMzRSxNQUFNLENBQUMsbUJBQW1CLEVBQUUscURBQXFELEVBQUUsS0FBSyxDQUFDLENBQ3pGLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSw4QkFBOEIsQ0FBQyxDQUN4RCxNQUFNLENBQUMsNkJBQTZCLEVBQUUsa0NBQWtDLENBQUMsQ0FDekUsTUFBTSxDQUFDLHNCQUFzQixFQUFFLHlFQUF5RSxDQUFDLENBQ3pHLE1BQU0sQ0FBQyxTQUFTLEVBQUUseUZBQXlGLENBQUMsQ0FDNUcsTUFBTSxDQUFDLHVCQUF1QixFQUFFLG9EQUFvRCxDQUFDLENBQ3JGLE1BQU0sQ0FBQyxVQUFVLEVBQUUsNEJBQTRCLENBQUMsQ0FDaEQsTUFBTSxDQUFDLFNBQVMsRUFBRSxpQ0FBaUMsQ0FBQyxDQUNwRCxNQUFNLENBQUMseUJBQXlCLEVBQUUsK0NBQStDLENBQUMsQ0FDbEYsTUFBTSxDQUFDLHlCQUF5QixFQUFFLG1FQUFtRSxDQUFDLENBQ3RHLE1BQU0sQ0FBQyxVQUFVLEVBQUUsNkVBQTZFLENBQUMsQ0FDakcsTUFBTSxDQUFDLGtCQUFrQixFQUFFLDJFQUEyRSxFQUFFLHdCQUF3QixDQUFDLENBQ2pJLE1BQU0sQ0FBQyxxQkFBcUIsRUFBRSw0Q0FBNEMsQ0FBQyxDQUMzRSxNQUFNLENBQUMsdUJBQXVCLEVBQUUscUZBQXFGLENBQUMsQ0FDdEgsTUFBTSxDQUFDLHdCQUF3QixFQUFFLHVFQUF1RSxDQUFDLENBQ3pHLE1BQU0sQ0FBQyxjQUFjLEVBQUUsd0JBQXdCLENBQUMsQ0FDaEQsTUFBTSxDQUFDLGNBQWMsRUFBRSwwQkFBMEIsQ0FBQyxDQUNsRCxNQUFNLENBQUMsb0JBQW9CLEVBQUUsbUNBQW1DLENBQUMsQ0FDakUsTUFBTSxDQUFDLG9CQUFvQixFQUFFLHlEQUF5RCxDQUFDLENBQ3ZGLE1BQU0sQ0FBQyx1QkFBdUIsRUFBRSxrREFBa0QsQ0FBQyxDQUNuRixNQUFNLENBQUMseUJBQXlCLEVBQUUsNkJBQTZCLENBQUMsQ0FDaEUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFBO0NBQzVCOztrQkFFYyxPQUFPO0FBRWYsU0FBUyxNQUFNLENBQUUsS0FBSyxFQUE4QjtNQUE1QixPQUFPLHlEQUFHLEVBQUU7TUFBRSxPQUFPLHlEQUFHLEVBQUU7O0FBQ3ZELE1BQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUE7O0FBRTdCLGVBQWEsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUE7O0FBRS9CLGNBQVksQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFBOztBQUVyQyxNQUFJLE9BQU8sQ0FBQyxLQUFLLEVBQUU7QUFDakIsZ0JBQVksQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUE7R0FDL0I7Q0FDRjs7QUFFTSxTQUFTLGFBQWEsQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFO0FBQzlDLE1BQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUE7O0FBRTdCLE1BQUksYUFBYSxHQUFHLE9BQU8sQ0FBQyxhQUFhLElBQUksd0JBQXdCLENBQUE7O0FBRXJFLFNBQU8sQ0FBQyxHQUFHLENBQUMsMEJBQTBCLENBQUMsS0FBSyxDQUFDLENBQUE7QUFDN0Msb0JBQU0sSUFBSSxDQUFLLGFBQWEsY0FBWSxDQUFBOztBQUV4QyxTQUFPLENBQUMsR0FBRyxDQUFDLDJCQUEyQixDQUFDLE1BQU0sQ0FBQyxDQUFBO0FBQy9DLE1BQUksSUFBSSxHQUFHLGtCQUFNLElBQUksK0VBQTJFLGFBQWEsU0FBTSxFQUFDLEtBQUssRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFBOztBQUVqSSxNQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsVUFBQyxJQUFJLEVBQUs7QUFDL0IsUUFBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUU7QUFDbEIsYUFBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtLQUNsQjtHQUNGLENBQUMsQ0FBQTs7QUFFRixNQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsVUFBQyxJQUFJLEVBQUs7QUFDL0IsUUFBRyxPQUFPLENBQUMsS0FBSyxFQUFFO0FBQ2hCLGFBQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUE7S0FDbEI7R0FDRixDQUFDLENBQUE7Q0FDSDs7QUFFTSxTQUFTLFlBQVksQ0FBRSxLQUFLLEVBQThCO01BQTVCLE9BQU8seURBQUcsRUFBRTtNQUFFLE9BQU8seURBQUcsRUFBRTs7QUFDN0QsTUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQTs7QUFFN0IsU0FBTyxDQUFDLEtBQUssR0FBRyxLQUFLLElBQUksT0FBTyxDQUFDLEtBQUssSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssSUFBSSxPQUFPLENBQUE7QUFDMUUsU0FBTyxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxJQUFJLFdBQVcsQ0FBQTs7QUFFckUsU0FBTyxDQUFDLFlBQVksR0FBRyxPQUFPLENBQUMsWUFBWSxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsWUFBWSxJQUFJLEVBQUUsQ0FBQTs7QUFFakYsU0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQTtBQUNwQyxTQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsR0FBRyxhQUFhLENBQUE7QUFDcEMsU0FBTyxDQUFLLGFBQWEsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLHFCQUFtQixDQUFDLE9BQU8sQ0FBQyxDQUFBO0NBQzVFOztBQUVNLFNBQVMsWUFBWSxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUU7QUFDN0MsTUFBSSxNQUFNLEdBQUcsa0JBQU0sSUFBSSxrQkFBZ0IsT0FBTyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUEsRUFBSyxFQUFDLEtBQUssRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFBOztBQUU5RSxTQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFBOztBQUVuQixRQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsVUFBQyxJQUFJLEVBQUs7QUFDakMsV0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtHQUNsQixDQUFDLENBQUE7O0FBRUYsUUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLFVBQUMsSUFBSSxFQUFLO0FBQ2pDLFdBQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUE7R0FDbEIsQ0FBQyxDQUFBOztBQUVGLFFBQU0sQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLFlBQU07QUFDcEIsV0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBO0dBQ25DLENBQUMsQ0FBQTtDQUNIOztBQUVELFNBQVMsYUFBYSxDQUFFLEdBQUcsRUFBRTtBQUFFLFNBQU8sQUFBQyxHQUFHLElBQUksVUE1Ry9CLE9BQU8sRUE0R2dDLEdBQUcsQ0FBQyxJQUFLLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLElBQUksVUE1RzVFLE9BQU8sRUE0RzhFLE9BQU8sQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFBO0NBQUU7O0FBRW5KLFNBQVMsaUJBQWlCLEdBQUk7QUFDNUIsTUFBSTtBQUNGLFdBQU8sYUFBYSxFQUFFLENBQUE7R0FDdkIsQ0FBQyxPQUFPLEtBQUssRUFBRTtBQUNkLFdBQU8sS0FBSyxDQUFBO0dBQ2I7Q0FDRiIsImZpbGUiOiJkZXZlbG9wLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgam9pbiwgcmVzb2x2ZSwgZGlybmFtZSB9IGZyb20gJ3BhdGgnXG5cbmltcG9ydCBzaGVsbCBmcm9tICdzaGVsbGpzJ1xuaW1wb3J0IHV0aWwgZnJvbSAnLi4vdXRpbCdcblxuZXhwb3J0IGZ1bmN0aW9uIGRldmVsb3AgKHByb2dyYW0sIGRpc3BhdGNoKSB7XG4gIHByb2dyYW1cbiAgICAuY29tbWFuZCgnZGV2IFtlbnRyeV0nKVxuICAgIC5hbGlhcygnZGV2ZWxvcCcpXG4gICAgLmFsaWFzKCdkZXYtc2VydmVyJylcbiAgICAuZGVzY3JpcHRpb24oJ3J1biBhIGRldmVsb3BtZW50IHNlcnZlciBmb3IgdGhpcyBwcm9qZWN0JylcbiAgICAub3B0aW9uKCctLXBvcnQgPHBvcnQ+JywgJ3doaWNoIHBvcnQgc2hvdWxkIHRoaXMgc2VydmVyIGxpc3RlbiBvbj8nLCAzMDAwKVxuICAgIC5vcHRpb24oJy0taG9zdCA8aG9zdG5hbWU+JywgJ3doaWNoIGhvc3RuYW1lIHNob3VsZCB0aGlzIHNlcnZlciBsaXN0ZW4gb24/JywgJ2xvY2FsaG9zdCcpXG4gICAgLm9wdGlvbignLS1lbnRyeSA8cGF0aD4nLCAncmVsYXRpdmUgcGF0aCB0byB0aGUgZW50cnkgcG9pbnQnLCAnLi9zcmMnKVxuICAgIC5vcHRpb24oJy0tZW50cnktbmFtZSA8bmFtZT4nLCAnd2hhdCB0byBuYW1lIHRoZSBlbnRyeSBwb2ludCBzY3JpcHQnLCAnYXBwJylcbiAgICAub3B0aW9uKCctLXBsYXRmb3JtIDxuYW1lPicsICd3aGljaCBwbGF0Zm9ybSBhcmUgd2UgYnVpbGRpbmcgZm9yPyBlbGVjdHJvbiBvciB3ZWInLCAnd2ViJylcbiAgICAub3B0aW9uKCctLXRoZW1lIDxuYW1lPicsICd0aGUgbmFtZSBvZiB0aGUgdGhlbWUgdG8gdXNlJylcbiAgICAub3B0aW9uKCctLWh0bWwtdGVtcGxhdGUtcGF0aCA8cGF0aD4nLCAncGF0aCB0byB0aGUgaHRtbCB0ZW1wbGF0ZSB0byB1c2UnKVxuICAgIC5vcHRpb24oJy0tcHJlY29tcGlsZWQgPG5hbWU+JywgJ3VzZSBhIHByZWNvbXBpbGVkIGh0bWwgdGVtcGxhdGUgd2hpY2ggaW5jbHVkZXMgdmVuZG9yIGxpYnMsIHRoZW1lcywgZXRjJylcbiAgICAub3B0aW9uKCctLW5ncm9rJywgJ3doZW4gZW5hYmxlZCwgd2lsbCBhdHRlbXB0IHRvIHVzZSBuZ3JvayB0byBleHBvc2UgYSBwdWJsaWMgQVBJIGVuZHBvaW50IGZvciB0aGlzIHNlcnZlcicpXG4gICAgLm9wdGlvbignLS1uZ3Jvay1jb25maWcgPHBhdGg+JywgJ3BhdGggdG8gYSBjb25maWd1cmF0aW9uIGZpbGUgZm9yIHRoZSBuZ3JvayBzZXJ2aWNlJylcbiAgICAub3B0aW9uKCctLXNpbGVudCcsICdzdXBwcmVzcyBhbnkgc2VydmVyIG91dHB1dCcpXG4gICAgLm9wdGlvbignLS1kZWJ1ZycsICdzaG93IGVycm9yIGluZm8gZnJvbSB0aGUgc2VydmVyJylcbiAgICAub3B0aW9uKCctLWRldi10b29scy1wYXRoIDxwYXRoPicsICdwYXRoIHRvIHRoZSBza3lwYWdlci1kZXZwYWNrIGRldnRvb2xzIGxpYnJhcnknKVxuICAgIC5vcHRpb24oJy0td2VicGFjay1jb25maWcgPHBhdGg+JywgJ3BhdGggdG8gYSBqYXZhc2NyaXB0IGZ1bmN0aW9uIHdoaWNoIGNhbiBtdXRhdGUgdGhlIHdlYnBhY2sgY29uZmlnJylcbiAgICAub3B0aW9uKCctLWJ1bmRsZScsICd3YXRjaCBmb3IgY29udGVudCBjaGFuZ2VzIGluIHRoZSBwcm9qZWN0IGFuZCB1cGRhdGUgdGhlIGRpc3RyaWJ1dGlvbiBidW5kbGUnKVxuICAgIC5vcHRpb24oJy0tYnVuZGxlLWNvbW1hbmQnLCAndGhlIGNvbW1hbmQgdG8gcnVuIHRvIGdlbmVyYXRlIHRoZSBidW5kbGUgZGVmYXVsdDogc2t5cGFnZXIgZXhwb3J0IGJ1bmRsZScsICdza3lwYWdlciBleHBvcnQgYnVuZGxlJylcbiAgICAub3B0aW9uKCctLW1pZGRsZXdhcmUgPHBhdGg+JywgJ2FwcGx5IGV4cHJlc3MgbWlkZGxld2FyZSB0byB0aGUgZGV2LXNlcnZlcicpXG4gICAgLm9wdGlvbignLS1tb2R1bGVzLXBhdGggPHBhdGg+JywgJ3doaWNoIG1vZHVsZXMgZm9sZGVyIHRvIHVzZSBmb3Igd2VicGFja3MgZGVmYXVsdD8gZGVmYXVsdHMgdG8gc3RhbmRhcmQgbm9kZV9tb2R1bGVzJylcbiAgICAub3B0aW9uKCctLWZlYXR1cmUtZmxhZ3MgPHBhdGg+JywgJ3BhdGggdG8gYSBzY3JpcHQgd2hpY2ggZXhwb3J0cyBhbiBvYmplY3QgdG8gYmUgdXNlZCBmb3IgZmVhdHVyZSBmbGFncycpXG4gICAgLm9wdGlvbignLS1za2lwLXRoZW1lJywgJ2RvIG5vdCBpbmNsdWRlIGEgdGhlbWUnKVxuICAgIC5vcHRpb24oJy0tZW50cnktb25seScsICdkbyBub3QgdXNlIGh0bWwgdGVtcGxhdGUnKVxuICAgIC5vcHRpb24oJy0tZGlzdC1wYXRoIDxwYXRoPicsICd0aGUgcHJvamVjdCBleHBvcnRlciBvciBkaXN0IHBhdGgnKVxuICAgIC5vcHRpb24oJy0tZXh0ZXJuYWwtdmVuZG9ycycsIFwiYXNzdW1lIHZlbmRvciBsaWJyYXJpZXMgd2lsbCBiZSBhdmFpbGFibGUgdG8gb3VyIHNjcmlwdFwiKVxuICAgIC5vcHRpb24oJy0tbm8tdmVuZG9yLWxpYnJhcmllcycsIFwiZG9uJ3QgaW5jbHVkZSBhbnkgdmVuZG9yIGxpYnJhcmllcyBpbiB0aGUgYnVuZGxlXCIpXG4gICAgLm9wdGlvbignLS1leHBvcnQtbGlicmFyeSA8bmFtZT4nLCAnYnVpbGQgdGhpcyBhcyBhIHVtZCBsaWJyYXJ5JylcbiAgICAuYWN0aW9uKGRpc3BhdGNoKGhhbmRsZSkpXG59XG5cbmV4cG9ydCBkZWZhdWx0IGRldmVsb3BcblxuZXhwb3J0IGZ1bmN0aW9uIGhhbmRsZSAoZW50cnksIG9wdGlvbnMgPSB7fSwgY29udGV4dCA9IHt9KSB7XG4gIGxldCBwcm9qZWN0ID0gY29udGV4dC5wcm9qZWN0XG5cbiAgbGF1bmNoV2F0Y2hlcihvcHRpb25zLCBjb250ZXh0KVxuXG4gIGxhdW5jaFNlcnZlcihlbnRyeSwgb3B0aW9ucywgY29udGV4dClcblxuICBpZiAob3B0aW9ucy5uZ3Jvaykge1xuICAgIGxhdW5jaFR1bm5lbChvcHRpb25zLCBjb250ZXh0KVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsYXVuY2hXYXRjaGVyKG9wdGlvbnMsIGNvbnRleHQpIHtcbiAgbGV0IHByb2plY3QgPSBjb250ZXh0LnByb2plY3RcblxuICBsZXQgYnVuZGxlQ29tbWFuZCA9IG9wdGlvbnMuYnVuZGxlQ29tbWFuZCB8fCAnc2t5cGFnZXIgZXhwb3J0IGJ1bmRsZSdcblxuICBjb25zb2xlLmxvZygnRXhwb3J0aW5nIHByb2plY3QgYnVuZGxlJy5ncmVlbilcbiAgc2hlbGwuZXhlYyhgJHsgYnVuZGxlQ29tbWFuZCB9IC0tY2xlYW5gKVxuXG4gIGNvbnNvbGUubG9nKCdMYXVuY2hpbmcgcHJvamVjdCBidW5kbGVyJy55ZWxsb3cpXG4gIHZhciBwcm9jID0gc2hlbGwuZXhlYyhgY2hva2lkYXIgJy4ve2RhdGEsZG9jc30vKiovKi4qJyAtLXNpbGVudCAtLWlnbm9yZSAtLWRlYm91bmNlIDEyMDAgLWMgJyR7IGJ1bmRsZUNvbW1hbmQgfSdgLCB7YXN5bmM6IHRydWV9KVxuXG4gIHByb2Muc3Rkb3V0Lm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICBpZighb3B0aW9ucy5zaWxlbnQpIHtcbiAgICAgIGNvbnNvbGUubG9nKGRhdGEpXG4gICAgfVxuICB9KVxuXG4gIHByb2Muc3RkZXJyLm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICBpZihvcHRpb25zLmRlYnVnKSB7XG4gICAgICBjb25zb2xlLmxvZyhkYXRhKVxuICAgIH1cbiAgfSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxhdW5jaFNlcnZlciAoZW50cnksIG9wdGlvbnMgPSB7fSwgY29udGV4dCA9IHt9KSB7XG4gIGxldCBwcm9qZWN0ID0gY29udGV4dC5wcm9qZWN0XG5cbiAgb3B0aW9ucy5lbnRyeSA9IGVudHJ5IHx8IG9wdGlvbnMuZW50cnkgfHwgcHJvamVjdC5vcHRpb25zLmVudHJ5IHx8ICcuL3NyYydcbiAgb3B0aW9ucy50aGVtZSA9IG9wdGlvbnMudGhlbWUgfHwgcHJvamVjdC5vcHRpb25zLnRoZW1lIHx8ICdtYXJrZXRpbmcnXG5cbiAgb3B0aW9ucy5zdGF0aWNBc3NldHMgPSBvcHRpb25zLnN0YXRpY0Fzc2V0cyB8fCBwcm9qZWN0Lm9wdGlvbnMuc3RhdGljQXNzZXRzIHx8IHt9XG5cbiAgY29uc29sZS5sb2coJ0xhdW5jaGluZyBzZXJ2ZXInLmN5YW4pXG4gIHByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ2RldmVsb3BtZW50J1xuICByZXF1aXJlKGAkeyBwYXRoVG9EZXZwYWNrKG9wdGlvbnMuZGV2VG9vbHNQYXRoKSB9L3dlYnBhY2svc2VydmVyYCkob3B0aW9ucylcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxhdW5jaFR1bm5lbChvcHRpb25zLCBjb250ZXh0KSB7XG4gIHZhciBzZXJ2ZXIgPSBzaGVsbC5leGVjKGBuZ3JvayBodHRwICR7IG9wdGlvbnMucG9ydCB8fCAzMDAwIH1gLCB7YXN5bmM6IHRydWV9KVxuXG4gIGNvbnNvbGUubG9nKHNlcnZlcilcblxuICBzZXJ2ZXIuc3Rkb3V0Lm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICBjb25zb2xlLmxvZyhkYXRhKVxuICB9KVxuXG4gIHNlcnZlci5zdGRlcnIub24oJ2RhdGEnLCAoZGF0YSkgPT4ge1xuICAgIGNvbnNvbGUubG9nKGRhdGEpXG4gIH0pXG5cbiAgc2VydmVyLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgIGNvbnNvbGUubG9nKCdOZ3JvayB0dW5uZWwgZW5kZWQnKVxuICB9KVxufVxuXG5mdW5jdGlvbiBwYXRoVG9EZXZwYWNrIChvcHQpIHsgcmV0dXJuIChvcHQgJiYgcmVzb2x2ZShvcHQpKSB8fCBwcm9jZXNzLmVudi5TS1lQQUdFUl9ERVZQQUNLX1BBVEggfHwgZGlybmFtZSggcmVxdWlyZS5yZXNvbHZlKCdza3lwYWdlci1kZXZwYWNrJykpIH1cblxuZnVuY3Rpb24gaXNEZXBhY2tJbnN0YWxsZWQgKCkge1xuICB0cnkge1xuICAgIHJldHVybiBwYXRoVG9EZXZwYWNrKClcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICByZXR1cm4gZmFsc2VcbiAgfVxufVxuIl19