'use strict';

var debug = require('debug')('skypager:exporters');

function CollectionBundle() {
  var options = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

  var project = options.project || this;

  var bundle = {};

  var allAssets = project.allAssets || [];

  allAssets.forEach(function (asset) {
    try {
      if (!asset.raw) {
        asset.runImporter('disk', { sync: true });
      }
    } catch (e) {
      debug('collection bundle error: ' + asset.uri);
      throw e;
    }
  });

  allAssets.forEach(function (asset) {
    try {
      var entry = bundle[asset.paths.projectRequire] = {
        id: asset.id,
        uri: asset.uri,
        raw: asset.raw,
        fingerprint: asset.fingerprint,
        path: asset.paths.projectRequire
      };

      if (asset.assetClass.name == 'DataSource') {
        delete entry.raw;
        entry.data = asset.data;
      }
    } catch (e) {
      debug("Collection Bundle Asset Error", e.message);
      throw e;
    }
  });

  return bundle;
}

module.exports = CollectionBundle;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9leHBvcnRlcnMvY29udGVudC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBOztBQUVsRCxTQUFTLGdCQUFnQixHQUFjO01BQWIsT0FBTyx5REFBRyxFQUFFOztBQUNwQyxNQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQTs7QUFFckMsTUFBSSxNQUFNLEdBQUcsRUFBRyxDQUFBOztBQUVoQixNQUFJLFNBQVMsR0FBRyxPQUFPLENBQUMsU0FBUyxJQUFJLEVBQUUsQ0FBQTs7QUFFckMsV0FBUyxDQUFDLE9BQU8sQ0FBQyxVQUFBLEtBQUssRUFBSTtBQUN6QixRQUFJO0FBQ0YsVUFBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUU7QUFBRSxhQUFLLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxFQUFDLElBQUksRUFBQyxJQUFJLEVBQUMsQ0FBQyxDQUFBO09BQUU7S0FDMUQsQ0FBQyxPQUFNLENBQUMsRUFBRTtBQUNULFdBQUssQ0FBQywyQkFBMkIsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUE7QUFDOUMsWUFBTSxDQUFDLENBQUM7S0FDVDtHQUNGLENBQUMsQ0FBQTs7QUFFSixXQUFTLENBQUMsT0FBTyxDQUFDLFVBQUEsS0FBSyxFQUFJO0FBQ3pCLFFBQUk7QUFDRixVQUFJLEtBQUssR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsR0FBRztBQUMvQyxVQUFFLEVBQUUsS0FBSyxDQUFDLEVBQUU7QUFDWixXQUFHLEVBQUUsS0FBSyxDQUFDLEdBQUc7QUFDZCxXQUFHLEVBQUUsS0FBSyxDQUFDLEdBQUc7QUFDZCxtQkFBVyxFQUFFLEtBQUssQ0FBQyxXQUFXO0FBQzlCLFlBQUksRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLGNBQWM7T0FDakMsQ0FBQTs7QUFFRCxVQUFJLEtBQUssQ0FBQyxVQUFVLENBQUMsSUFBSSxJQUFJLFlBQVksRUFBRTtBQUN6QyxlQUFPLEtBQUssQ0FBQyxHQUFHLEFBQUMsQ0FBQTtBQUNqQixhQUFLLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUE7T0FDeEI7S0FFRixDQUFDLE9BQU0sQ0FBQyxFQUFFO0FBQ1QsV0FBSyxDQUFDLCtCQUErQixFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQTtBQUNqRCxZQUFNLENBQUMsQ0FBQztLQUNUO0dBQ0YsQ0FBQyxDQUFBOztBQUVGLFNBQU8sTUFBTSxDQUFBO0NBQ2Q7O0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRyxnQkFBZ0IsQ0FBQSIsImZpbGUiOiJjb250ZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKSgnc2t5cGFnZXI6ZXhwb3J0ZXJzJylcblxuZnVuY3Rpb24gQ29sbGVjdGlvbkJ1bmRsZShvcHRpb25zID0ge30pe1xuICBsZXQgcHJvamVjdCA9IG9wdGlvbnMucHJvamVjdCB8fCB0aGlzXG5cbiAgbGV0IGJ1bmRsZSA9IHsgfVxuXG4gIGxldCBhbGxBc3NldHMgPSBwcm9qZWN0LmFsbEFzc2V0cyB8fCBbXVxuXG4gICAgYWxsQXNzZXRzLmZvckVhY2goYXNzZXQgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgaWYoIWFzc2V0LnJhdykgeyBhc3NldC5ydW5JbXBvcnRlcignZGlzaycsIHtzeW5jOnRydWV9KSB9XG4gICAgICB9IGNhdGNoKGUpIHtcbiAgICAgICAgZGVidWcoJ2NvbGxlY3Rpb24gYnVuZGxlIGVycm9yOiAnICsgYXNzZXQudXJpKVxuICAgICAgICB0aHJvdyhlKVxuICAgICAgfVxuICAgIH0pXG5cbiAgYWxsQXNzZXRzLmZvckVhY2goYXNzZXQgPT4ge1xuICAgIHRyeSB7XG4gICAgICBsZXQgZW50cnkgPSBidW5kbGVbYXNzZXQucGF0aHMucHJvamVjdFJlcXVpcmVdID0ge1xuICAgICAgICBpZDogYXNzZXQuaWQsXG4gICAgICAgIHVyaTogYXNzZXQudXJpLFxuICAgICAgICByYXc6IGFzc2V0LnJhdyxcbiAgICAgICAgZmluZ2VycHJpbnQ6IGFzc2V0LmZpbmdlcnByaW50LFxuICAgICAgICBwYXRoOiBhc3NldC5wYXRocy5wcm9qZWN0UmVxdWlyZVxuICAgICAgfVxuXG4gICAgICBpZiAoYXNzZXQuYXNzZXRDbGFzcy5uYW1lID09ICdEYXRhU291cmNlJykge1xuICAgICAgICBkZWxldGUoZW50cnkucmF3KVxuICAgICAgICBlbnRyeS5kYXRhID0gYXNzZXQuZGF0YVxuICAgICAgfVxuXG4gICAgfSBjYXRjaChlKSB7XG4gICAgICBkZWJ1ZyhcIkNvbGxlY3Rpb24gQnVuZGxlIEFzc2V0IEVycm9yXCIsIGUubWVzc2FnZSlcbiAgICAgIHRocm93KGUpXG4gICAgfVxuICB9KVxuXG4gIHJldHVybiBidW5kbGVcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBDb2xsZWN0aW9uQnVuZGxlXG4iXX0=