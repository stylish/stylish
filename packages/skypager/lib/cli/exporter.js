'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.exporter = exporter;
exports.handle = handle;

var _path = require('path');

var _fs = require('fs');

var _yargs = require('yargs');

var _mkdirp = require('mkdirp');

var _mkdirp2 = _interopRequireDefault(_mkdirp);

var _colors = require('colors');

var _colors2 = _interopRequireDefault(_colors);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function exporter(program, dispatch) {
  program.command('export <exporter>').description('run one of the project exporters').option('--format <format>', 'which format should the output be serialized in', 'json').option('--output <path>', 'where to save the contents').option('--pretty', 'pretty print the output').option('--stdout', 'write output to stdout').action(dispatch(handle));
}

exports.default = exporter;
function handle(exporterId) {
  var options = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  var context = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];
  var project = context.project;

  var exporter = project.registries.exporters.lookup(exporterId, false);

  if (!exporter) {
    abort('could not find and exporter named ' + exporterId);
  }

  var params = Object.assign({}, _yargs.argv, { project: project });

  var payload = project.run.exporter(exporterId, params);

  var output = undefined;

  if (options.format === 'json' && options.pretty) {
    output = JSON.stringify(payload, null, 2);
  } else if (options.format === 'json') {
    output = JSON.stringify(payload);
  } else if (options.format === 'yaml') {
    output = yaml.dump(payload);
  }

  if (options.output) {
    var outputPath = (0, _path.resolve)((0, _path.normalize)(options.output));
    (0, _fs.writeFileSync)(outputPath, output.toString(), 'utf8');
  } else if (options.stdout) {
    console.log(output);
  } else if (exporterId === 'bundle') {
    var outputPath = project.path('build', 'bundle.js');
    var assets = project.run.exporter('assets', params);
    var entities = project.run.exporter('entities', params);
    var _project = project.run.exporter('project', params);

    (0, _fs.writeFileSync)(project.path('build', 'bundle/__assets.js'), 'module.exports = ' + JSON.stringify(assets));
    (0, _fs.writeFileSync)(project.path('build', 'bundle/__entities.js'), 'module.exports = ' + JSON.stringify(entities));
    (0, _fs.writeFileSync)(project.path('build', 'bundle/__project.js'), 'module.exports = ' + JSON.stringify(_project));

    (0, _fs.writeFileSync)(outputPath, 'module.exports = require(\'./bundle/index\');', 'utf8');
    console.log('Saved exporter to ' + outputPath);
  }
}

function abort(message) {
  console.log(message.red);
  process.exit(0);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvZXhwb3J0ZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7UUFRZ0IsUUFBUSxHQUFSLFFBQVE7UUFhUixNQUFNLEdBQU4sTUFBTTs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBYmYsU0FBUyxRQUFRLENBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRTtBQUMzQyxTQUFPLENBQ0osT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQzVCLFdBQVcsQ0FBQyxrQ0FBa0MsQ0FBQyxDQUMvQyxNQUFNLENBQUMsbUJBQW1CLEVBQUUsaURBQWlELEVBQUUsTUFBTSxDQUFDLENBQ3RGLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRSw0QkFBNEIsQ0FBQyxDQUN2RCxNQUFNLENBQUMsVUFBVSxFQUFFLHlCQUF5QixDQUFDLENBQzdDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsd0JBQXdCLENBQUMsQ0FDNUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFBO0NBQzVCOztrQkFFYyxRQUFRO0FBRWhCLFNBQVMsTUFBTSxDQUFFLFVBQVUsRUFBOEI7TUFBNUIsT0FBTyx5REFBRyxFQUFFO01BQUUsT0FBTyx5REFBRyxFQUFFO01BQ3BELE9BQU8sR0FBSyxPQUFPLENBQW5CLE9BQU87O0FBQ2YsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsQ0FBQTs7QUFFdkUsTUFBSSxDQUFDLFFBQVEsRUFBRTtBQUNiLFNBQUssd0NBQXVDLFVBQVUsQ0FBSSxDQUFBO0dBQzNEOztBQUVELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxTQTFCeEIsSUFBSSxFQTBCNEIsRUFBQyxPQUFPLEVBQVAsT0FBTyxFQUFDLENBQUMsQ0FBQTs7QUFFakQsTUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFBOztBQUV0RCxNQUFJLE1BQU0sWUFBQSxDQUFBOztBQUVWLE1BQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxNQUFNLElBQUksT0FBTyxDQUFDLE1BQU0sRUFBRTtBQUM5QyxVQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFBO0dBQzNDLE1BQU0sSUFBSSxPQUFPLENBQUMsTUFBTSxLQUFLLE1BQU0sRUFBRTtBQUNuQyxVQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQTtHQUNsQyxNQUFNLElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxNQUFNLEVBQUU7QUFDcEMsVUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7R0FDNUI7O0FBRUQsTUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFO0FBQ2xCLFFBQUksVUFBVSxHQUFHLFVBNUNOLE9BQU8sRUE0Q08sVUE1Q0ksU0FBUyxFQTRDSCxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQTtBQUNuRCxZQTVDSyxhQUFhLEVBNENaLFVBQVUsRUFBRSxNQUFNLENBQUMsUUFBUSxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUE7R0FDN0MsTUFBTSxJQUFJLE9BQU8sQ0FBQyxNQUFNLEVBQUU7QUFDeEIsV0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQTtHQUNyQixNQUFNLElBQUksVUFBVSxLQUFLLFFBQVEsRUFBRTtBQUNsQyxRQUFJLFVBQVUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUMsQ0FBQTtBQUNuRCxRQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUE7QUFDbkQsUUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFBO0FBQ3ZELFFBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQTs7QUFFdEQsWUFyREssYUFBYSxFQXFEWixPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxvQkFBb0IsQ0FBQyxFQUFFLG1CQUFtQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQTtBQUNoRyxZQXRESyxhQUFhLEVBc0RaLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLHNCQUFzQixDQUFDLEVBQUUsbUJBQW1CLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFBO0FBQ3BHLFlBdkRLLGFBQWEsRUF1RFosT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUscUJBQXFCLENBQUMsRUFBRSxtQkFBbUIsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUE7O0FBRW5HLFlBekRLLGFBQWEsRUF5RFosVUFBVSxtREFBa0QsTUFBTSxDQUFDLENBQUE7QUFDekUsV0FBTyxDQUFDLEdBQUcsd0JBQXVCLFVBQVUsQ0FBSSxDQUFBO0dBQ2pEO0NBQ0Y7O0FBRUQsU0FBUyxLQUFLLENBQUMsT0FBTyxFQUFFO0FBQ3JCLFNBQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0FBQ3hCLFNBQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7Q0FDakIiLCJmaWxlIjoiZXhwb3J0ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBqb2luLCByZXNvbHZlLCBkaXJuYW1lLCBub3JtYWxpemUsIGV4aXN0c1N5bmMgYXMgZXhpc3RzIH0gZnJvbSAncGF0aCdcbmltcG9ydCB7IHdyaXRlRmlsZVN5bmMgYXMgd3JpdGUsIHN0YXRTeW5jIGFzIHN0YXQgfSBmcm9tICdmcydcblxuaW1wb3J0IHsgYXJndiB9IGZyb20gJ3lhcmdzJ1xuXG5pbXBvcnQgbWtkaXJwIGZyb20gJ21rZGlycCdcbmltcG9ydCBjb2xvcnMgZnJvbSAnY29sb3JzJ1xuXG5leHBvcnQgZnVuY3Rpb24gZXhwb3J0ZXIgKHByb2dyYW0sIGRpc3BhdGNoKSB7XG4gIHByb2dyYW1cbiAgICAuY29tbWFuZCgnZXhwb3J0IDxleHBvcnRlcj4nKVxuICAgIC5kZXNjcmlwdGlvbigncnVuIG9uZSBvZiB0aGUgcHJvamVjdCBleHBvcnRlcnMnKVxuICAgIC5vcHRpb24oJy0tZm9ybWF0IDxmb3JtYXQ+JywgJ3doaWNoIGZvcm1hdCBzaG91bGQgdGhlIG91dHB1dCBiZSBzZXJpYWxpemVkIGluJywgJ2pzb24nKVxuICAgIC5vcHRpb24oJy0tb3V0cHV0IDxwYXRoPicsICd3aGVyZSB0byBzYXZlIHRoZSBjb250ZW50cycpXG4gICAgLm9wdGlvbignLS1wcmV0dHknLCAncHJldHR5IHByaW50IHRoZSBvdXRwdXQnKVxuICAgIC5vcHRpb24oJy0tc3Rkb3V0JywgJ3dyaXRlIG91dHB1dCB0byBzdGRvdXQnKVxuICAgIC5hY3Rpb24oZGlzcGF0Y2goaGFuZGxlKSlcbn1cblxuZXhwb3J0IGRlZmF1bHQgZXhwb3J0ZXJcblxuZXhwb3J0IGZ1bmN0aW9uIGhhbmRsZSAoZXhwb3J0ZXJJZCwgb3B0aW9ucyA9IHt9LCBjb250ZXh0ID0ge30pIHtcbiAgY29uc3QgeyBwcm9qZWN0IH0gPSBjb250ZXh0XG4gIGNvbnN0IGV4cG9ydGVyID0gcHJvamVjdC5yZWdpc3RyaWVzLmV4cG9ydGVycy5sb29rdXAoZXhwb3J0ZXJJZCwgZmFsc2UpXG5cbiAgaWYgKCFleHBvcnRlcikge1xuICAgIGFib3J0KGBjb3VsZCBub3QgZmluZCBhbmQgZXhwb3J0ZXIgbmFtZWQgJHsgZXhwb3J0ZXJJZCB9YClcbiAgfVxuXG4gIGNvbnN0IHBhcmFtcyA9IE9iamVjdC5hc3NpZ24oe30sIGFyZ3YsIHtwcm9qZWN0fSlcblxuICBsZXQgcGF5bG9hZCA9IHByb2plY3QucnVuLmV4cG9ydGVyKGV4cG9ydGVySWQsIHBhcmFtcylcblxuICBsZXQgb3V0cHV0XG5cbiAgaWYgKG9wdGlvbnMuZm9ybWF0ID09PSAnanNvbicgJiYgb3B0aW9ucy5wcmV0dHkpIHtcbiAgICAgb3V0cHV0ID0gSlNPTi5zdHJpbmdpZnkocGF5bG9hZCwgbnVsbCwgMilcbiAgfSBlbHNlIGlmIChvcHRpb25zLmZvcm1hdCA9PT0gJ2pzb24nKSB7XG4gICAgIG91dHB1dCA9IEpTT04uc3RyaW5naWZ5KHBheWxvYWQpXG4gIH0gZWxzZSBpZiAob3B0aW9ucy5mb3JtYXQgPT09ICd5YW1sJykge1xuICAgIG91dHB1dCA9IHlhbWwuZHVtcChwYXlsb2FkKVxuICB9XG5cbiAgaWYgKG9wdGlvbnMub3V0cHV0KSB7XG4gICAgbGV0IG91dHB1dFBhdGggPSByZXNvbHZlKG5vcm1hbGl6ZShvcHRpb25zLm91dHB1dCkpXG4gICAgd3JpdGUob3V0cHV0UGF0aCwgb3V0cHV0LnRvU3RyaW5nKCksICd1dGY4JylcbiAgfSBlbHNlIGlmIChvcHRpb25zLnN0ZG91dCkge1xuICAgICBjb25zb2xlLmxvZyhvdXRwdXQpXG4gIH0gZWxzZSBpZiAoZXhwb3J0ZXJJZCA9PT0gJ2J1bmRsZScpIHtcbiAgICBsZXQgb3V0cHV0UGF0aCA9IHByb2plY3QucGF0aCgnYnVpbGQnLCAnYnVuZGxlLmpzJylcbiAgICBsZXQgYXNzZXRzID0gcHJvamVjdC5ydW4uZXhwb3J0ZXIoJ2Fzc2V0cycsIHBhcmFtcylcbiAgICBsZXQgZW50aXRpZXMgPSBwcm9qZWN0LnJ1bi5leHBvcnRlcignZW50aXRpZXMnLCBwYXJhbXMpXG4gICAgbGV0IF9wcm9qZWN0ID0gcHJvamVjdC5ydW4uZXhwb3J0ZXIoJ3Byb2plY3QnLCBwYXJhbXMpXG5cbiAgICB3cml0ZShwcm9qZWN0LnBhdGgoJ2J1aWxkJywgJ2J1bmRsZS9fX2Fzc2V0cy5qcycpLCAnbW9kdWxlLmV4cG9ydHMgPSAnICsgSlNPTi5zdHJpbmdpZnkoYXNzZXRzKSlcbiAgICB3cml0ZShwcm9qZWN0LnBhdGgoJ2J1aWxkJywgJ2J1bmRsZS9fX2VudGl0aWVzLmpzJyksICdtb2R1bGUuZXhwb3J0cyA9ICcgKyBKU09OLnN0cmluZ2lmeShlbnRpdGllcykpXG4gICAgd3JpdGUocHJvamVjdC5wYXRoKCdidWlsZCcsICdidW5kbGUvX19wcm9qZWN0LmpzJyksICdtb2R1bGUuZXhwb3J0cyA9ICcgKyBKU09OLnN0cmluZ2lmeShfcHJvamVjdCkpXG5cbiAgICB3cml0ZShvdXRwdXRQYXRoLCAgYG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnLi9idW5kbGUvaW5kZXgnKTtgLCAndXRmOCcpXG4gICAgY29uc29sZS5sb2coYFNhdmVkIGV4cG9ydGVyIHRvICR7IG91dHB1dFBhdGggfWApXG4gIH1cbn1cblxuZnVuY3Rpb24gYWJvcnQobWVzc2FnZSkge1xuICAgY29uc29sZS5sb2cobWVzc2FnZS5yZWQpXG4gICBwcm9jZXNzLmV4aXQoMClcbn1cbiJdfQ==