'use strict';

var _util = require('../../util');

function _typeof(obj) { return obj && typeof Symbol !== "undefined" && obj.constructor === Symbol ? "symbol" : typeof obj; }

module.exports = {
  nodes: function nodes(document, type) {
    var params = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];

    return buildFilterInterface(document);
  },
  code: function code(document) {
    var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

    return buildCodeInterface(document);
  },
  headings: function headings(document) {
    var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

    return buildHeadingsInterface(document);
  },
  applyToNode: function applyToNode() {
    return _applyToNode.apply(undefined, arguments);
  }
};

function extractHeadingText(node) {
  if ((typeof node === 'undefined' ? 'undefined' : _typeof(node)) === 'object' && node.type === 'heading' && node.children) {
    return node.children[0].value;
  }
}

function buildHeadingsInterface(document, scope, titleDepth) {
  var headingNodes = scope ? scope : nodesByType.call(document, 'heading');

  titleDepth = titleDepth || document.startDepth || 1;

  return {
    section: function section(heading) {
      var relative = arguments.length <= 1 || arguments[1] === undefined ? false : arguments[1];

      var nodes = document.nodes.at.id((0, _util.slugify)(heading)).descendants;
      return buildHeadingsInterface(document, nodes);
    },

    /**
    * For specially named sections which have articles,
    * what are they called? this is a convenience method so
    * we can generate css class names to make them easily queryable
    */
    articleNameFor: function articleNameFor(sectionName) {
      if (document.modelDefinition && document.modelDefinition.sectionsConfig) {
        var cfg = document.modelDefinition.sectionsConfig[(0, _util.slugify)(sectionName)];

        if (cfg && cfg.config.articles) {
          return Object.values(cfg.config.articles)[0];
        }
      }
    },

    get titles() {
      return wrapQueryResponse(_query(headingNodes, { depth: titleDepth }));
    },
    get sections() {
      return wrapQueryResponse(_query(headingNodes, { depth: titleDepth + 1 }));
    },
    get articles() {
      return wrapQueryResponse(_query(headingNodes, { depth: titleDepth + 2 }));
    },
    get minor() {
      var depths = [titleDepth + 3, titleDepth + 4, titleDepth + 5];
      return wrapQueryResponse(_query(headingNodes, { depth: depths }));
    }
  };
}

function buildCodeInterface(document) {
  var blocks = nodesByType.call(document, 'code');
  return wrapCodeBlocks.call(document, blocks);
}

function wrapCodeBlocks(codeBlocks) {
  var document = this;

  var i = {
    get languages() {
      return wrapQueryResponse(codeBlocks).pluck('lang').unique();
    },
    get all() {
      return wrapQueryResponse(codeBlocks);
    },

    get grouped() {
      return codeBlocks.reduce(function (memo, block) {
        (memo[block.lang] = memo[block.lang] || []).push(block);
        return memo;
      }, {});
    },

    under: function under(heading) {
      var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

      var results = document.nodes.at.id((0, _util.slugify)(heading)).descendants.filter(function (b) {
        return b.type === 'code';
      });
      return wrapQueryResponse(results, params);
    }
  };

  codeBlocks.map(function (block) {
    return block.lang;
  }).forEach(function (lang) {
    if (!i[lang]) {
      Object.defineProperty(i, lang, {
        get: function get() {
          return wrapQueryResponse(codeBlocks, { lang: lang }) || [];
        }
      });
    }
  });

  return i;
}

function buildFilterInterface(document) {
  if (!document.indexes) {
    document.indexed;
  }

  var types = Object.keys(document.indexes.types);

  var lines = document.indexes.lines;
  var ids = document.indexes.ids;

  var typeFilter = nodesByType.bind(document);

  var findById = function findById(id) {
    return document.indexed.children[ids[id]];
  };

  var i = {
    query: function query() {
      var params = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

      return _query(document.indexed.children, params);
    },
    under: function under(heading) {
      var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

      var results = document.nodes.at.id((0, _util.slugify)(heading)).descendants;
      return wrapQueryResponse(results, params);
    },
    including: function including(heading) {
      var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

      var headingNode = document.nodes.at.id((0, _util.slugify)(heading));
      var results = [headingNode].concat(document.nodes.at.id((0, _util.slugify)(heading)).descendants);

      return wrapQueryResponse(results, params);
    },
    type: typeFilter.bind(document),
    of: {
      type: typeFilter.bind(document)
    },
    at: (0, _util.assign)(findById, {
      line: function line(i) {
        return document.indexed.children[lines[i]];
      },
      index: function index(i) {
        return document.indexed.children[i];
      },
      id: findById
    })
  };

  // document.nodes.headings
  types.forEach(function (type) {
    Object.defineProperty(i, type + 's', {
      enumerable: false,
      get: function get() {
        return typeFilter(type);
      }
    });
  });

  return i;
}

function nodesUnderHeading(heading, params) {
  var nodes = this.nodes.at.id((0, _util.slugify)(heading)).descendants;
  return wrapQueryResponse(node, params);
}

function nodesByType(type, params) {
  var nodes = this.indexed.children;
  var results = (this.indexes.types[type] || []).map(function (pointer) {
    return nodes[pointer];
  });
  return wrapQueryResponse(results, params);
}

function queryNodes() {
  var params = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

  var nodes = params.nodes || this.indexed.children;
  return wrapQueryResponse(nodes, params);
}

function _query(nodeList) {
  var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  return nodeList.filter(function (node) {
    return Object.keys(params).every(function (key) {
      var param = params[key];
      var value = node[key];

      if (isRegex(param) && param.test(value)) {
        return true;
      }

      if (typeof param === 'string' && value === param) {
        return true;
      }

      if (typeof param === 'number' && value === param) {
        return true;
      }
    });
  });
}

function extractText(node) {
  if (node.children && node.children[0]) {
    if (node.children[0] && node.children[0].type === 'text' && node.children[0].value) {
      return node.children[0].value;
    }
  }
}

function isRegex(val) {
  if ((typeof val === 'undefined' ? 'undefined' : _typeof(val)) === 'object' && Object.getPrototypeOf(val).toString() === '/(?:)/') {
    return true;
  }

  return false;
}

function wrapQueryResponse(results, params) {
  var response = _query(results, params).sort(function (a, b) {
    return a.index - b.index;
  });

  (0, _util.assign)(response, {
    query: function query(params) {
      return wrapQueryResponse(response, params);
    },

    get markdown() {
      return (0, _util.flatten)(response.map(function (node) {
        return node.lines.raw;
      })).join('\n');
    },
    get raw() {
      return (0, _util.flatten)(response.map(function (node) {
        return node.lines.raw;
      }));
    },
    get text() {
      return response.map(function (node) {
        return extractText(node);
      });
    },
    get first() {
      return response[0];
    },
    get last() {
      return response[response.length - 1];
    }
  });

  return response.sort(function (a, b) {
    return a.index - b.index;
  });
}

function nextSibling(node, nodes, depthsIndex, idsIndex) {
  var myIndex = depthsIndex[node.depth].indexOf(node.index);
  var nextIndex = depthsIndex[node.depth][myIndex + 1];
  if (nextIndex && nodes[nextIndex]) {
    return nodes[nextIndex];
  }
}

function previousSibling(node, nodes, depthsIndex, idsIndex) {
  var myIndex = depthsIndex[node.depth].indexOf(node.index);
  var nextIndex = depthsIndex[node.depth][myIndex - 1];
  if (nextIndex > 0 && nextIndex && nodes[nextIndex]) {
    return nodes[nextIndex];
  }
}

function allChildren(node, nodes, ids, childrenIndexes) {
  var indexes = childrenIndexes[node.id];

  if (!indexes) {
    return [];
  }

  var results = indexes.map(function (i) {
    return nodes[i];
  });

  return results.reduce(function (memo, child, index) {
    if (child.type === 'heading') {
      memo.push(child);
      memo = memo.concat(allChildren(child, nodes, ids, childrenIndexes).sort(function (a, b) {
        return parseInt(a.index) - parseInt(b.index);
      }));
    } else {
      memo.push(child);
    }
    return memo;
  }, []).sort(function (a, b) {
    return parseInt(a.index) - parseInt(b.index);
  });
}

function firstTypeInterface(node) {
  var obj = {};

  node.descendants.forEach(function (descendant) {
    if (!obj[descendant.type]) {
      Object.defineProperty(obj, descendant.type, {
        enumerable: false,
        get: function get() {
          return descendant;
        }
      });
    }
  });

  return obj;
}

function _applyToNode(node) {
  var options = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  var nodes = options.nodes;
  var document = options.document;
  var _document$indexes = document.indexes;
  var ids = _document$indexes.ids;
  var types = _document$indexes.types;
  var depths = _document$indexes.depths;
  var childrenIndexes = _document$indexes.childrenIndexes;

  (0, _util.lazy)(node, 'parent', function () {
    return nodes[ids[node.parentId]];
  }, false);

  _util.hide.getter(node, 'document', function () {
    return document;
  });

  (0, _util.lazy)(node, 'lines', function () {
    return {
      start: node.position.start.line,
      end: node.position.end.line,
      get raw() {
        var start = node.position.start.line;
        var end = node.position.end.line;
        return document.lines.slice(start - 1, end);
      }
    };
  }, false);

  if (node.type === 'heading') {
    _util.hide.property(node, 'siblings', {});

    // node.siblings.next
    (0, _util.lazy)(node.siblings, 'next', function () {
      return nextSibling(node, nodes, depths, ids);
    }, false);

    // node.siblings.previous
    (0, _util.lazy)(node.siblings, 'previous', function () {
      return previousSibling(node, nodes, depths, ids);
    }, false);

    (0, _util.lazy)(node, 'descendants', function () {
      return allChildren(node, nodes, ids, childrenIndexes);
    }, false);

    (0, _util.lazy)(node, 'childHeadings', function () {
      return _query(node.descendants, { type: 'heading', depth: node.depth + 1 });
    });

    (0, _util.lazy)(node, 'paragraphs', function () {
      return _query(nodes, { type: 'paragraph', parentId: node.id });
    });

    (0, _util.lazy)(node, 'codeBlocks', function () {
      return _query(nodes, { type: 'code', parentId: node.id });
    });

    (0, _util.lazy)(node, 'first', function () {
      return firstTypeInterface(node);
    }, false);

    (0, _util.assign)(node, {
      query: function query() {
        for (var _len = arguments.length, rest = Array(_len), _key = 0; _key < _len; _key++) {
          rest[_key] = arguments[_key];
        }

        return _query.apply(undefined, [node.descendants].concat(rest));
      }
    });
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hc3NldHMvZG9jdW1lbnQvcXVlcnlfaW50ZXJmYWNlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUVBLE1BQU0sQ0FBQyxPQUFPLEdBQUc7QUFDZixPQUFLLGlCQUFFLFFBQVEsRUFBRSxJQUFJLEVBQWU7UUFBYixNQUFNLHlEQUFHLEVBQUU7O0FBQ2hDLFdBQU8sb0JBQW9CLENBQUMsUUFBUSxDQUFDLENBQUE7R0FDdEM7QUFDRCxNQUFJLGdCQUFFLFFBQVEsRUFBZTtRQUFiLE1BQU0seURBQUcsRUFBRTs7QUFDekIsV0FBTyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsQ0FBQTtHQUNwQztBQUNELFVBQVEsb0JBQUUsUUFBUSxFQUFlO1FBQWIsTUFBTSx5REFBRyxFQUFFOztBQUM3QixXQUFPLHNCQUFzQixDQUFDLFFBQVEsQ0FBQyxDQUFBO0dBQ3hDO0FBQ0QsYUFBVyx5QkFBVztBQUNwQixXQUFPLFlBQVcsNEJBQVMsQ0FBQTtHQUM1QjtDQUNGLENBQUE7O0FBRUQsU0FBUyxrQkFBa0IsQ0FBRSxJQUFJLEVBQUU7QUFDakMsTUFBSSxRQUFRLElBQUkseUNBQUosSUFBSSxPQUFJLFFBQVEsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFNBQVMsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO0FBQ3hFLFdBQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUE7R0FDOUI7Q0FDRjs7QUFFRCxTQUFTLHNCQUFzQixDQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFO0FBQzVELE1BQUksWUFBWSxHQUFHLEtBQUssR0FBRyxLQUFLLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsU0FBUyxDQUFDLENBQUE7O0FBRXhFLFlBQVUsR0FBRyxVQUFVLElBQUksUUFBUSxDQUFDLFVBQVUsSUFBSSxDQUFDLENBQUE7O0FBRW5ELFNBQU87QUFDTCxXQUFPLG1CQUFFLE9BQU8s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ZUFBTyxNQUFLLG1CQUFDLElBQUksQ0FBQyxXQUFXLFNBQUssSUFBSSxFQUFDLENBQUE7T0FDeEM7S0FDRixDQUFDLENBQUE7R0FDSDtDQUVGIiwiZmlsZSI6InF1ZXJ5X2ludGVyZmFjZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFzc2lnbiwgaGlkZSwgbGF6eSwgc2x1Z2lmeSwgdW5kZXJzY29yZSwgZmxhdHRlbiB9IGZyb20gJy4uLy4uL3V0aWwnXG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBub2RlcyAoZG9jdW1lbnQsIHR5cGUsIHBhcmFtcyA9IHt9KSB7XG4gICAgcmV0dXJuIGJ1aWxkRmlsdGVySW50ZXJmYWNlKGRvY3VtZW50KVxuICB9LFxuICBjb2RlIChkb2N1bWVudCwgcGFyYW1zID0ge30pIHtcbiAgICByZXR1cm4gYnVpbGRDb2RlSW50ZXJmYWNlKGRvY3VtZW50KVxuICB9LFxuICBoZWFkaW5ncyAoZG9jdW1lbnQsIHBhcmFtcyA9IHt9KSB7XG4gICAgcmV0dXJuIGJ1aWxkSGVhZGluZ3NJbnRlcmZhY2UoZG9jdW1lbnQpXG4gIH0sXG4gIGFwcGx5VG9Ob2RlICguLi5hcmdzKSB7XG4gICAgcmV0dXJuIGFwcGx5VG9Ob2RlKC4uLmFyZ3MpXG4gIH1cbn1cblxuZnVuY3Rpb24gZXh0cmFjdEhlYWRpbmdUZXh0IChub2RlKSB7XG4gIGlmICh0eXBlb2YgKG5vZGUpPT09J29iamVjdCcgJiYgbm9kZS50eXBlID09PSAnaGVhZGluZycgJiYgbm9kZS5jaGlsZHJlbikge1xuICAgIHJldHVybiBub2RlLmNoaWxkcmVuWzBdLnZhbHVlXG4gIH1cbn1cblxuZnVuY3Rpb24gYnVpbGRIZWFkaW5nc0ludGVyZmFjZSAoZG9jdW1lbnQsIHNjb3BlLCB0aXRsZURlcHRoKSB7XG4gIGxldCBoZWFkaW5nTm9kZXMgPSBzY29wZSA/IHNjb3BlIDogbm9kZXNCeVR5cGUuY2FsbChkb2N1bWVudCwgJ2hlYWRpbmcnKVxuXG4gIHRpdGxlRGVwdGggPSB0aXRsZURlcHRoIHx8IGRvY3VtZW50LnN0YXJ0RGVwdGggfHwgMVxuXG4gIHJldHVybiB7XG4gICAgc2VjdGlvbiAoaGVhZGluZywgcmVsYXRpdmUgPSBmYWxzZSkge1xuICAgICAgbGV0IG5vZGVzID0gZG9jdW1lbnQubm9kZXMuYXQuaWQoc2x1Z2lmeShoZWFkaW5nKSkuZGVzY2VuZGFudHNcbiAgICAgIHJldHVybiBidWlsZEhlYWRpbmdzSW50ZXJmYWNlKGRvY3VtZW50LCBub2RlcylcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgKiBGb3Igc3BlY2lhbGx5IG5hbWVkIHNlY3Rpb25zIHdoaWNoIGhhdmUgYXJ0aWNsZXMsXG4gICAgKiB3aGF0IGFyZSB0aGV5IGNhbGxlZD8gdGhpcyBpcyBhIGNvbnZlbmllbmNlIG1ldGhvZCBzb1xuICAgICogd2UgY2FuIGdlbmVyYXRlIGNzcyBjbGFzcyBuYW1lcyB0byBtYWtlIHRoZW0gZWFzaWx5IHF1ZXJ5YWJsZVxuICAgICovXG4gICAgYXJ0aWNsZU5hbWVGb3IgKHNlY3Rpb25OYW1lKSB7XG4gICAgICAgIGlmKGRvY3VtZW50Lm1vZGVsRGVmaW5pdGlvbiAmJiBkb2N1bWVudC5tb2RlbERlZmluaXRpb24uc2VjdGlvbnNDb25maWcpe1xuICAgICAgICAgICAgbGV0IGNmZyA9IGRvY3VtZW50Lm1vZGVsRGVmaW5pdGlvbi5zZWN0aW9uc0NvbmZpZ1sgc2x1Z2lmeShzZWN0aW9uTmFtZSkgXVxuXG4gICAgICAgICAgICBpZihjZmcgJiYgY2ZnLmNvbmZpZy5hcnRpY2xlcykge1xuICAgICAgICAgICAgICAgIHJldHVybiBPYmplY3QudmFsdWVzKGNmZy5jb25maWcuYXJ0aWNsZXMpWzBdXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgZ2V0IHRpdGxlcyAoKSB7XG4gICAgICByZXR1cm4gd3JhcFF1ZXJ5UmVzcG9uc2UocXVlcnkoaGVhZGluZ05vZGVzLCB7ZGVwdGg6IHRpdGxlRGVwdGh9KSlcbiAgICB9LFxuICAgIGdldCBzZWN0aW9ucyAoKSB7XG4gICAgICByZXR1cm4gd3JhcFF1ZXJ5UmVzcG9uc2UocXVlcnkoaGVhZGluZ05vZGVzLCB7ZGVwdGg6IHRpdGxlRGVwdGggKyAxfSkpXG4gICAgfSxcbiAgICBnZXQgYXJ0aWNsZXMgKCkge1xuICAgICAgcmV0dXJuIHdyYXBRdWVyeVJlc3BvbnNlKHF1ZXJ5KGhlYWRpbmdOb2Rlcywge2RlcHRoOiB0aXRsZURlcHRoICsgMn0pKVxuICAgIH0sXG4gICAgZ2V0IG1pbm9yICgpIHtcbiAgICAgIGxldCBkZXB0aHMgPSBbdGl0bGVEZXB0aCArIDMsIHRpdGxlRGVwdGggKyA0LCB0aXRsZURlcHRoICsgNV1cbiAgICAgIHJldHVybiB3cmFwUXVlcnlSZXNwb25zZShxdWVyeShoZWFkaW5nTm9kZXMsIHtkZXB0aDogZGVwdGhzfSkpXG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGJ1aWxkQ29kZUludGVyZmFjZSAoZG9jdW1lbnQpIHtcbiAgbGV0IGJsb2NrcyA9IG5vZGVzQnlUeXBlLmNhbGwoZG9jdW1lbnQsICdjb2RlJylcbiAgcmV0dXJuIHdyYXBDb2RlQmxvY2tzLmNhbGwoZG9jdW1lbnQsIGJsb2Nrcylcbn1cblxuZnVuY3Rpb24gd3JhcENvZGVCbG9ja3MgKGNvZGVCbG9ja3MpIHtcbiAgbGV0IGRvY3VtZW50ID0gdGhpc1xuXG4gIGxldCBpID0ge1xuICAgIGdldCBsYW5ndWFnZXMgKCkge1xuICAgICAgcmV0dXJuIHdyYXBRdWVyeVJlc3BvbnNlKGNvZGVCbG9ja3MpLnBsdWNrKCdsYW5nJykudW5pcXVlKClcbiAgICB9LFxuICAgIGdldCBhbGwgKCkge1xuICAgICAgcmV0dXJuIHdyYXBRdWVyeVJlc3BvbnNlKGNvZGVCbG9ja3MpXG4gICAgfSxcblxuICAgIGdldCBncm91cGVkICgpIHtcbiAgICAgIHJldHVybiBjb2RlQmxvY2tzLnJlZHVjZSgobWVtbywgYmxvY2spID0+IHtcbiAgICAgICAgKG1lbW9bYmxvY2subGFuZ10gPSBtZW1vW2Jsb2NrLmxhbmddIHx8IFtdKS5wdXNoKGJsb2NrKVxuICAgICAgICByZXR1cm4gbWVtb1xuICAgICAgfSwge30pXG4gICAgfSxcblxuICAgIHVuZGVyIChoZWFkaW5nLCBwYXJhbXMgPSB7fSkge1xuICAgICAgbGV0IHJlc3VsdHMgPSBkb2N1bWVudC5ub2Rlcy5hdC5pZChzbHVnaWZ5KGhlYWRpbmcpKS5kZXNjZW5kYW50cy5maWx0ZXIoYiA9PiBiLnR5cGUgPT09ICdjb2RlJylcbiAgICAgIHJldHVybiB3cmFwUXVlcnlSZXNwb25zZShyZXN1bHRzLCBwYXJhbXMpXG4gICAgfVxuICB9XG5cbiAgY29kZUJsb2Nrcy5tYXAoYmxvY2sgPT4gYmxvY2subGFuZykuZm9yRWFjaChsYW5nID0+IHtcbiAgICBpZiAoIWlbbGFuZ10pIHtcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShpLCBsYW5nLCB7XG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgIHJldHVybiB3cmFwUXVlcnlSZXNwb25zZShjb2RlQmxvY2tzLCB7bGFuZ30pIHx8IFtdXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfVxuICB9KVxuXG4gIHJldHVybiBpXG59XG5cbmZ1bmN0aW9uIGJ1aWxkRmlsdGVySW50ZXJmYWNlIChkb2N1bWVudCkge1xuICBpZiAoIWRvY3VtZW50LmluZGV4ZXMpIHsgZG9jdW1lbnQuaW5kZXhlZCB9XG5cbiAgbGV0IHR5cGVzID0gT2JqZWN0LmtleXMoZG9jdW1lbnQuaW5kZXhlcy50eXBlcylcblxuICBsZXQgbGluZXMgPSBkb2N1bWVudC5pbmRleGVzLmxpbmVzXG4gIGxldCBpZHMgPSBkb2N1bWVudC5pbmRleGVzLmlkc1xuXG4gIGxldCB0eXBlRmlsdGVyID0gbm9kZXNCeVR5cGUuYmluZChkb2N1bWVudClcblxuICBsZXQgZmluZEJ5SWQgPSBmdW5jdGlvbiAoaWQpIHtcbiAgICByZXR1cm4gZG9jdW1lbnQuaW5kZXhlZC5jaGlsZHJlblsgaWRzW2lkXSBdXG4gIH1cblxuICBsZXQgaSA9IHtcbiAgICBxdWVyeTogZnVuY3Rpb24gKHBhcmFtcyA9IHt9KSB7XG4gICAgICByZXR1cm4gcXVlcnkoZG9jdW1lbnQuaW5kZXhlZC5jaGlsZHJlbiwgcGFyYW1zKVxuICAgIH0sXG4gICAgdW5kZXI6IGZ1bmN0aW9uIChoZWFkaW5nLCBwYXJhbXMgPSB7fSkge1xuICAgICAgbGV0IHJlc3VsdHMgPSBkb2N1bWVudC5ub2Rlcy5hdC5pZChzbHVnaWZ5KGhlYWRpbmcpKS5kZXNjZW5kYW50c1xuICAgICAgcmV0dXJuIHdyYXBRdWVyeVJlc3BvbnNlKHJlc3VsdHMsIHBhcmFtcylcbiAgICB9LFxuICAgIGluY2x1ZGluZzogZnVuY3Rpb24gKGhlYWRpbmcsIHBhcmFtcyA9IHt9KSB7XG4gICAgICBsZXQgaGVhZGluZ05vZGUgPSBkb2N1bWVudC5ub2Rlcy5hdC5pZChzbHVnaWZ5KGhlYWRpbmcpKVxuICAgICAgbGV0IHJlc3VsdHMgPSBbaGVhZGluZ05vZGVdLmNvbmNhdChkb2N1bWVudC5ub2Rlcy5hdC5pZChzbHVnaWZ5KGhlYWRpbmcpKS5kZXNjZW5kYW50cylcblxuICAgICAgcmV0dXJuIHdyYXBRdWVyeVJlc3BvbnNlKHJlc3VsdHMsIHBhcmFtcylcbiAgICB9LFxuICAgIHR5cGU6IHR5cGVGaWx0ZXIuYmluZChkb2N1bWVudCksXG4gICAgb2Y6IHtcbiAgICAgIHR5cGU6IHR5cGVGaWx0ZXIuYmluZChkb2N1bWVudClcbiAgICB9LFxuICAgIGF0OiBhc3NpZ24oZmluZEJ5SWQsIHtcbiAgICAgIGxpbmU6ICgoaSkgPT4gZG9jdW1lbnQuaW5kZXhlZC5jaGlsZHJlblsgbGluZXNbaV0gXSksXG4gICAgICBpbmRleDogKChpKSA9PiBkb2N1bWVudC5pbmRleGVkLmNoaWxkcmVuW2ldKSxcbiAgICAgIGlkOiBmaW5kQnlJZFxuICAgIH0pXG4gIH1cblxuICAvLyBkb2N1bWVudC5ub2Rlcy5oZWFkaW5nc1xuICB0eXBlcy5mb3JFYWNoKHR5cGUgPT4ge1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShpLCB0eXBlICsgJ3MnLCB7XG4gICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcbiAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gdHlwZUZpbHRlcih0eXBlKVxuICAgICAgfVxuICAgIH0pXG4gIH0pXG5cbiAgcmV0dXJuIGlcbn1cblxuZnVuY3Rpb24gbm9kZXNVbmRlckhlYWRpbmcgKGhlYWRpbmcsIHBhcmFtcykge1xuICBsZXQgbm9kZXMgPSB0aGlzLm5vZGVzLmF0LmlkKHNsdWdpZnkoaGVhZGluZykpLmRlc2NlbmRhbnRzXG4gIHJldHVybiB3cmFwUXVlcnlSZXNwb25zZShub2RlLCBwYXJhbXMpXG59XG5cblxuZnVuY3Rpb24gbm9kZXNCeVR5cGUgKHR5cGUsIHBhcmFtcykge1xuICBsZXQgbm9kZXMgPSB0aGlzLmluZGV4ZWQuY2hpbGRyZW5cbiAgbGV0IHJlc3VsdHMgPSAodGhpcy5pbmRleGVzLnR5cGVzW3R5cGVdIHx8IFtdKS5tYXAocG9pbnRlciA9PiBub2Rlc1twb2ludGVyXSlcbiAgcmV0dXJuIHdyYXBRdWVyeVJlc3BvbnNlKHJlc3VsdHMsIHBhcmFtcylcbn1cblxuZnVuY3Rpb24gcXVlcnlOb2RlcyAocGFyYW1zID0ge30pIHtcbiAgbGV0IG5vZGVzID0gcGFyYW1zLm5vZGVzIHx8IHRoaXMuaW5kZXhlZC5jaGlsZHJlblxuICByZXR1cm4gd3JhcFF1ZXJ5UmVzcG9uc2Uobm9kZXMsIHBhcmFtcylcbn1cblxuZnVuY3Rpb24gcXVlcnkgKG5vZGVMaXN0LCBwYXJhbXMgPSB7fSkge1xuICByZXR1cm4gbm9kZUxpc3QuZmlsdGVyKG5vZGUgPT4ge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyhwYXJhbXMpLmV2ZXJ5KGtleSA9PiB7XG4gICAgICBsZXQgcGFyYW0gPSBwYXJhbXNba2V5XVxuICAgICAgbGV0IHZhbHVlID0gbm9kZVtrZXldXG5cbiAgICAgIGlmIChpc1JlZ2V4KHBhcmFtKSAmJiBwYXJhbS50ZXN0KHZhbHVlKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgfVxuXG4gICAgICBpZiAodHlwZW9mIChwYXJhbSk9PT0nc3RyaW5nJyAmJiB2YWx1ZSA9PT0gcGFyYW0pIHtcbiAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgIH1cblxuICAgICAgaWYgKHR5cGVvZiAocGFyYW0pPT09J251bWJlcicgJiYgdmFsdWUgPT09IHBhcmFtKSB7XG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgICB9XG4gICAgfSlcbiAgfSlcbn1cblxuZnVuY3Rpb24gZXh0cmFjdFRleHQgKG5vZGUpIHtcbiAgaWYgKG5vZGUuY2hpbGRyZW4gJiYgbm9kZS5jaGlsZHJlblswXSkge1xuICAgIGlmIChub2RlLmNoaWxkcmVuWzBdICYmIG5vZGUuY2hpbGRyZW5bMF0udHlwZSA9PT0gJ3RleHQnICYmIG5vZGUuY2hpbGRyZW5bMF0udmFsdWUpIHtcbiAgICAgIHJldHVybiBub2RlLmNoaWxkcmVuWzBdLnZhbHVlXG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGlzUmVnZXggKHZhbCkge1xuICBpZiAodHlwZW9mICh2YWwpPT09J29iamVjdCcgJiYgT2JqZWN0LmdldFByb3RvdHlwZU9mKHZhbCkudG9TdHJpbmcoKSA9PT0gJy8oPzopLycpIHtcbiAgICByZXR1cm4gdHJ1ZVxuICB9XG5cbiAgcmV0dXJuIGZhbHNlXG59XG5cbmZ1bmN0aW9uIHdyYXBRdWVyeVJlc3BvbnNlIChyZXN1bHRzLCBwYXJhbXMpIHtcbiAgbGV0IHJlc3BvbnNlID0gcXVlcnkocmVzdWx0cywgcGFyYW1zKS5zb3J0KChhLCBiKSA9PiBhLmluZGV4IC0gYi5pbmRleClcblxuICBhc3NpZ24ocmVzcG9uc2UsIHtcbiAgICBxdWVyeSAocGFyYW1zKSB7XG4gICAgICByZXR1cm4gd3JhcFF1ZXJ5UmVzcG9uc2UocmVzcG9uc2UsIHBhcmFtcylcbiAgICB9LFxuICAgIGdldCBtYXJrZG93biAoKSB7XG4gICAgICByZXR1cm4gZmxhdHRlbihyZXNwb25zZS5tYXAobm9kZSA9PiBub2RlLmxpbmVzLnJhdykpLmpvaW4oJ1xcbicpXG4gICAgfSxcbiAgICBnZXQgcmF3ICgpIHtcbiAgICAgIHJldHVybiBmbGF0dGVuKHJlc3BvbnNlLm1hcChub2RlID0+IG5vZGUubGluZXMucmF3KSlcbiAgICB9LFxuICAgIGdldCB0ZXh0ICgpIHtcbiAgICAgIHJldHVybiByZXNwb25zZS5tYXAobm9kZSA9PiBleHRyYWN0VGV4dChub2RlKSlcbiAgICB9LFxuICAgIGdldCBmaXJzdCgpIHtcbiAgICAgIHJldHVybiByZXNwb25zZVswXVxuICAgIH0sXG4gICAgZ2V0IGxhc3QoKXtcbiAgICAgIHJldHVybiByZXNwb25zZVsgcmVzcG9uc2UubGVuZ3RoIC0gMSBdXG4gICAgfVxuICB9KVxuXG4gIHJldHVybiByZXNwb25zZS5zb3J0KChhLGIpID0+IGEuaW5kZXggLSBiLmluZGV4KVxufVxuXG5mdW5jdGlvbiBuZXh0U2libGluZyAobm9kZSwgbm9kZXMsIGRlcHRoc0luZGV4LCBpZHNJbmRleCkge1xuICBsZXQgbXlJbmRleCA9IGRlcHRoc0luZGV4W25vZGUuZGVwdGhdLmluZGV4T2Yobm9kZS5pbmRleClcbiAgbGV0IG5leHRJbmRleCA9IGRlcHRoc0luZGV4W25vZGUuZGVwdGhdW215SW5kZXggKyAxXVxuICBpZiAobmV4dEluZGV4ICYmIG5vZGVzW25leHRJbmRleF0pIHtcbiAgICByZXR1cm4gbm9kZXNbbmV4dEluZGV4XVxuICB9XG59XG5cbmZ1bmN0aW9uIHByZXZpb3VzU2libGluZyAobm9kZSwgbm9kZXMsIGRlcHRoc0luZGV4LCBpZHNJbmRleCkge1xuICBsZXQgbXlJbmRleCA9IGRlcHRoc0luZGV4W25vZGUuZGVwdGhdLmluZGV4T2Yobm9kZS5pbmRleClcbiAgbGV0IG5leHRJbmRleCA9IGRlcHRoc0luZGV4W25vZGUuZGVwdGhdW215SW5kZXggLSAxXVxuICBpZiAobmV4dEluZGV4ID4gMCAmJiBuZXh0SW5kZXggJiYgbm9kZXNbbmV4dEluZGV4XSkge1xuICAgIHJldHVybiBub2Rlc1tuZXh0SW5kZXhdXG4gIH1cbn1cblxuZnVuY3Rpb24gYWxsQ2hpbGRyZW4gKG5vZGUsIG5vZGVzLCBpZHMsIGNoaWxkcmVuSW5kZXhlcykge1xuICBsZXQgaW5kZXhlcyA9IGNoaWxkcmVuSW5kZXhlc1tub2RlLmlkXVxuXG4gIGlmICghaW5kZXhlcykgeyByZXR1cm4gW10gfVxuXG4gIGxldCByZXN1bHRzID0gaW5kZXhlcy5tYXAoaSA9PiBub2Rlc1tpXSlcblxuICByZXR1cm4gcmVzdWx0cy5yZWR1Y2UoKG1lbW8sIGNoaWxkLCBpbmRleCkgPT4ge1xuICAgIGlmIChjaGlsZC50eXBlID09PSAnaGVhZGluZycpIHtcbiAgICAgIG1lbW8ucHVzaChjaGlsZClcbiAgICAgIG1lbW8gPSBtZW1vLmNvbmNhdChhbGxDaGlsZHJlbihjaGlsZCwgbm9kZXMsIGlkcywgY2hpbGRyZW5JbmRleGVzKS5zb3J0KChhLGIpPT5wYXJzZUludChhLmluZGV4KS1wYXJzZUludChiLmluZGV4KSkpXG4gICAgfSBlbHNlIHtcbiAgICAgIG1lbW8ucHVzaChjaGlsZClcbiAgICB9XG4gICAgcmV0dXJuIG1lbW9cbiAgfSwgW10pLnNvcnQoKGEsYikgPT4gcGFyc2VJbnQoYS5pbmRleCkgLSBwYXJzZUludChiLmluZGV4KSlcbn1cblxuZnVuY3Rpb24gZmlyc3RUeXBlSW50ZXJmYWNlIChub2RlKSB7XG4gIGxldCBvYmogPSB7fVxuXG4gIG5vZGUuZGVzY2VuZGFudHMuZm9yRWFjaChkZXNjZW5kYW50ID0+IHtcbiAgICBpZiAoIW9ialtkZXNjZW5kYW50LnR5cGVdKSB7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBkZXNjZW5kYW50LnR5cGUsIHtcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkgeyByZXR1cm4gZGVzY2VuZGFudCB9XG4gICAgICB9KVxuICAgIH1cbiAgfSlcblxuICByZXR1cm4gb2JqXG59XG5cbmZ1bmN0aW9uIGFwcGx5VG9Ob2RlIChub2RlLCBvcHRpb25zID0ge30pIHtcbiAgbGV0IHsgbm9kZXMsIGRvY3VtZW50IH0gPSBvcHRpb25zXG4gIGxldCB7IGlkcywgdHlwZXMsIGRlcHRocywgY2hpbGRyZW5JbmRleGVzIH0gPSBkb2N1bWVudC5pbmRleGVzXG5cbiAgbGF6eShub2RlLCAncGFyZW50JywgKCgpID0+IG5vZGVzWyBpZHNbbm9kZS5wYXJlbnRJZF0gXSApLCBmYWxzZSlcblxuICBoaWRlLmdldHRlcihub2RlLCAnZG9jdW1lbnQnLCAoKCkgPT4gZG9jdW1lbnQpKVxuXG4gIGxhenkobm9kZSwgJ2xpbmVzJywgZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB7XG4gICAgICBzdGFydDogbm9kZS5wb3NpdGlvbi5zdGFydC5saW5lLFxuICAgICAgZW5kOiBub2RlLnBvc2l0aW9uLmVuZC5saW5lLFxuICAgICAgZ2V0IHJhdyAoKSB7XG4gICAgICAgIGxldCBzdGFydCA9IG5vZGUucG9zaXRpb24uc3RhcnQubGluZVxuICAgICAgICBsZXQgZW5kID0gbm9kZS5wb3NpdGlvbi5lbmQubGluZVxuICAgICAgICByZXR1cm4gZG9jdW1lbnQubGluZXMuc2xpY2Uoc3RhcnQgLSAxLCBlbmQpXG4gICAgICB9XG4gICAgfVxuICB9LCBmYWxzZSlcblxuICBpZiAobm9kZS50eXBlID09PSAnaGVhZGluZycpIHtcbiAgICBoaWRlLnByb3BlcnR5KG5vZGUsICdzaWJsaW5ncycsIHt9KVxuXG4gICAgLy8gbm9kZS5zaWJsaW5ncy5uZXh0XG4gICAgbGF6eShub2RlLnNpYmxpbmdzLCAnbmV4dCcsICgoKSA9PiBuZXh0U2libGluZyhub2RlLCBub2RlcywgZGVwdGhzLCBpZHMpICksIGZhbHNlKVxuXG4gICAgLy8gbm9kZS5zaWJsaW5ncy5wcmV2aW91c1xuICAgIGxhenkobm9kZS5zaWJsaW5ncywgJ3ByZXZpb3VzJywgKCgpID0+IHByZXZpb3VzU2libGluZyhub2RlLCBub2RlcywgZGVwdGhzLCBpZHMpICksIGZhbHNlKVxuXG4gICAgbGF6eShub2RlLCAnZGVzY2VuZGFudHMnLCAoZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIGFsbENoaWxkcmVuKG5vZGUsIG5vZGVzLCBpZHMsIGNoaWxkcmVuSW5kZXhlcylcbiAgICB9KSwgZmFsc2UpXG5cbiAgICBsYXp5KG5vZGUsICdjaGlsZEhlYWRpbmdzJywgKGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBxdWVyeShub2RlLmRlc2NlbmRhbnRzLCB7dHlwZTonaGVhZGluZycsIGRlcHRoOiBub2RlLmRlcHRoICsgMX0pXG4gICAgfSkpXG5cbiAgICBsYXp5KG5vZGUsICdwYXJhZ3JhcGhzJywgKGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBxdWVyeShub2Rlcywge3R5cGU6J3BhcmFncmFwaCcsIHBhcmVudElkOiBub2RlLmlkfSlcbiAgICB9KSlcblxuICAgIGxhenkobm9kZSwgJ2NvZGVCbG9ja3MnLCAoZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIHF1ZXJ5KG5vZGVzLCB7dHlwZTonY29kZScsIHBhcmVudElkOiBub2RlLmlkfSlcbiAgICB9KSlcblxuICAgIGxhenkobm9kZSwgJ2ZpcnN0JywgKGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBmaXJzdFR5cGVJbnRlcmZhY2Uobm9kZSlcbiAgICB9KSwgZmFsc2UpXG5cbiAgICBhc3NpZ24obm9kZSwge1xuICAgICAgcXVlcnkgKC4uLnJlc3QpIHtcbiAgICAgICAgcmV0dXJuIHF1ZXJ5KG5vZGUuZGVzY2VuZGFudHMsIC4uLnJlc3QpXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG59XG5cbiJdfQ==