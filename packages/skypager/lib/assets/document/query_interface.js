'use strict';

var _util = require('../../util');

function _typeof(obj) { return obj && typeof Symbol !== "undefined" && obj.constructor === Symbol ? "symbol" : typeof obj; }

/**
 * The Document Query Interface decorates the nodes in our Markdown AST with
 * helper methods which can be used to inspect the content, and query the document
 * to find child nodes, sibling nodes, and other information such as nested code blocks
 * with the language javascript, or anything else.
 */
module.exports = {
  nodes: function nodes(document, type) {
    var params = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];

    return buildFilterInterface(document);
  },
  code: function code(document) {
    var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

    return buildCodeInterface(document);
  },
  headings: function headings(document) {
    var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

    return buildHeadingsInterface(document);
  },
  applyToNode: function applyToNode() {
    return _applyToNode.apply(undefined, arguments);
  }
};

function extractHeadingText(node) {
  if ((typeof node === 'undefined' ? 'undefined' : _typeof(node)) === 'object' && node.type === 'heading' && node.children) {
    return node.children[0].value;
  }
}

function buildHeadingsInterface(document, scope, titleDepth) {
  var headingNodes = scope ? scope : nodesByType.call(document, 'heading');

  titleDepth = titleDepth || document.startDepth || 1;

  return {
    section: function section(heading) {
      var relative = arguments.length <= 1 || arguments[1] === undefined ? false : arguments[1];

      var nodes = document.nodes.at.id((0, _util.slugify)(heading)).descendants;
      return buildHeadingsInterface(document, nodes);
    },

    /**
    * For specially named sections which have articles,
    * what are they called? this is a convenience method so
    * we can generate css class names to make them easily queryable
    */
    articleNameFor: function articleNameFor(sectionName) {
      if (document.modelDefinition && document.modelDefinition.sectionsConfig) {
        var cfg = document.modelDefinition.sectionsConfig[(0, _util.slugify)(sectionName)];

        if (cfg && cfg.config.articles) {
          return Object.values(cfg.config.articles)[0];
        }
      }
    },

    get titles() {
      return wrapQueryResponse(_query(headingNodes, { depth: titleDepth }));
    },
    get sections() {
      return wrapQueryResponse(_query(headingNodes, { depth: titleDepth + 1 }));
    },
    get articles() {
      return wrapQueryResponse(_query(headingNodes, { depth: titleDepth + 2 }));
    },
    get minor() {
      var depths = [titleDepth + 3, titleDepth + 4, titleDepth + 5];
      return wrapQueryResponse(_query(headingNodes, { depth: depths }));
    }
  };
}

function buildCodeInterface(document) {
  var blocks = nodesByType.call(document, 'code');
  return wrapCodeBlocks.call(document, blocks);
}

function wrapCodeBlocks(codeBlocks) {
  var document = this;

  var i = {
    get languages() {
      return wrapQueryResponse(codeBlocks).pluck('lang').unique();
    },
    get all() {
      return wrapQueryResponse(codeBlocks);
    },

    get grouped() {
      return codeBlocks.reduce(function (memo, block) {
        (memo[block.lang] = memo[block.lang] || []).push(block);
        return memo;
      }, {});
    },

    under: function under(heading) {
      var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

      var results = document.nodes.at.id((0, _util.slugify)(heading)).descendants.filter(function (b) {
        return b.type === 'code';
      });
      return wrapQueryResponse(results, params);
    }
  };

  codeBlocks.map(function (block) {
    return block.lang;
  }).forEach(function (lang) {
    if (!i[lang]) {
      Object.defineProperty(i, lang, {
        get: function get() {
          return wrapQueryResponse(codeBlocks, { lang: lang }) || [];
        }
      });
    }
  });

  return i;
}

function buildFilterInterface(document) {
  if (!document.indexes) {
    document.indexed;
  }

  var types = Object.keys(document.indexes.types);

  var lines = document.indexes.lines;
  var ids = document.indexes.ids;

  var typeFilter = nodesByType.bind(document);

  var findById = function findById(id) {
    return document.indexed.children[ids[id]];
  };

  var i = {
    query: function query() {
      var params = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

      return _query(document.indexed.children, params);
    },
    under: function under(heading) {
      var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

      var results = document.nodes.at.id((0, _util.slugify)(heading)).descendants;
      return wrapQueryResponse(results, params);
    },
    including: function including(heading) {
      var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

      var headingNode = document.nodes.at.id((0, _util.slugify)(heading));
      var results = [headingNode].concat(document.nodes.at.id((0, _util.slugify)(heading)).descendants);

      return wrapQueryResponse(results, params);
    },
    type: typeFilter.bind(document),
    of: {
      type: typeFilter.bind(document)
    },
    at: (0, _util.assign)(findById, {
      line: function line(i) {
        return document.indexed.children[lines[i]];
      },
      index: function index(i) {
        return document.indexed.children[i];
      },
      id: findById
    })
  };

  // document.nodes.headings
  types.forEach(function (type) {
    Object.defineProperty(i, type + 's', {
      enumerable: false,
      get: function get() {
        return typeFilter(type);
      }
    });
  });

  return i;
}

function nodesUnderHeading(heading, params) {
  var nodes = this.nodes.at.id((0, _util.slugify)(heading)).descendants;
  return wrapQueryResponse(node, params);
}

function nodesByType(type, params) {
  var nodes = this.indexed.children;
  var results = (this.indexes.types[type] || []).map(function (pointer) {
    return nodes[pointer];
  });
  return wrapQueryResponse(results, params);
}

function queryNodes() {
  var params = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

  var nodes = params.nodes || this.indexed.children;
  return wrapQueryResponse(nodes, params);
}

function _query(nodeList) {
  var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  return (0, _util.filterQuery)(nodeList, params);
}

function extractText(node) {
  if (node.children && node.children[0]) {
    if (node.children[0] && node.children[0].type === 'text' && node.children[0].value) {
      return node.children[0].value;
    }
  }
}

function isRegex(val) {
  if ((typeof val === 'undefined' ? 'undefined' : _typeof(val)) === 'object' && Object.getPrototypeOf(val).toString() === '/(?:)/') {
    return true;
  }

  return false;
}

function wrapQueryResponse(results, params) {
  var response = _query(results, params).sort(function (a, b) {
    return a.index - b.index;
  });

  (0, _util.assign)(response, {
    query: function query(params) {
      return wrapQueryResponse(response, params);
    },

    get markdown() {
      return (0, _util.flatten)(response.map(function (node) {
        return node.lines.raw;
      })).join('\n');
    },
    get raw() {
      return (0, _util.flatten)(response.map(function (node) {
        return node.lines.raw;
      }));
    },
    get text() {
      return response.map(function (node) {
        return extractText(node);
      });
    },
    get first() {
      return response[0];
    },
    get last() {
      return response[response.length - 1];
    }
  });

  return response.sort(function (a, b) {
    return a.index - b.index;
  });
}

function nextSibling(node, nodes, depthsIndex, idsIndex) {
  var myIndex = depthsIndex[node.depth].indexOf(node.index);
  var nextIndex = depthsIndex[node.depth][myIndex + 1];
  if (nextIndex && nodes[nextIndex]) {
    return nodes[nextIndex];
  }
}

function previousSibling(node, nodes, depthsIndex, idsIndex) {
  var myIndex = depthsIndex[node.depth].indexOf(node.index);
  var nextIndex = depthsIndex[node.depth][myIndex - 1];
  if (nextIndex > 0 && nextIndex && nodes[nextIndex]) {
    return nodes[nextIndex];
  }
}

function allChildren(node, nodes, ids, childrenIndexes) {
  var indexes = childrenIndexes[node.id];

  if (!indexes) {
    return [];
  }

  var results = indexes.map(function (i) {
    return nodes[i];
  });

  return results.reduce(function (memo, child, index) {
    if (child.type === 'heading') {
      memo.push(child);
      memo = memo.concat(allChildren(child, nodes, ids, childrenIndexes).sort(function (a, b) {
        return parseInt(a.index) - parseInt(b.index);
      }));
    } else {
      memo.push(child);
    }
    return memo;
  }, []).sort(function (a, b) {
    return parseInt(a.index) - parseInt(b.index);
  });
}

function firstTypeInterface(node) {
  var obj = {};

  node.descendants.forEach(function (descendant) {
    if (!obj[descendant.type]) {
      Object.defineProperty(obj, descendant.type, {
        enumerable: false,
        get: function get() {
          return descendant;
        }
      });
    }
  });

  return obj;
}

function _applyToNode(node) {
  var options = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  var nodes = options.nodes;
  var document = options.document;
  var _document$indexes = document.indexes;
  var ids = _document$indexes.ids;
  var types = _document$indexes.types;
  var depths = _document$indexes.depths;
  var childrenIndexes = _document$indexes.childrenIndexes;

  (0, _util.lazy)(node, 'parent', function () {
    return nodes[ids[node.parentId]];
  }, false);

  _util.hide.getter(node, 'document', function () {
    return document;
  });

  (0, _util.lazy)(node, 'lines', function () {
    return {
      start: node.position.start.line,
      end: node.position.end.line,
      get raw() {
        var start = node.position.start.line;
        var end = node.position.end.line;
        return document.lines.slice(start - 1, end);
      }
    };
  }, false);

  if (node.type === 'heading') {
    _util.hide.property(node, 'siblings', {});

    // node.siblings.next
    (0, _util.lazy)(node.siblings, 'next', function () {
      return nextSibling(node, nodes, depths, ids);
    }, false);

    // node.siblings.previous
    (0, _util.lazy)(node.siblings, 'previous', function () {
      return previousSibling(node, nodes, depths, ids);
    }, false);

    (0, _util.lazy)(node, 'descendants', function () {
      return allChildren(node, nodes, ids, childrenIndexes);
    }, false);

    (0, _util.lazy)(node, 'childHeadings', function () {
      return _query(node.descendants, { type: 'heading', depth: node.depth + 1 });
    });

    (0, _util.lazy)(node, 'paragraphs', function () {
      return _query(nodes, { type: 'paragraph', parentId: node.id });
    });

    (0, _util.lazy)(node, 'codeBlocks', function () {
      return _query(nodes, { type: 'code', parentId: node.id });
    });

    (0, _util.lazy)(node, 'first', function () {
      return firstTypeInterface(node);
    }, false);

    (0, _util.assign)(node, {
      query: function query() {
        for (var _len = arguments.length, rest = Array(_len), _key = 0; _key < _len; _key++) {
          rest[_key] = arguments[_key];
        }

        return _query.apply(undefined, [node.descendants].concat(rest));
      }
    });
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hc3NldHMvZG9jdW1lbnQvcXVlcnlfaW50ZXJmYWNlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQU9BLE1BQU0sQ0FBQyxPQUFPLEdBQUc7QUFDZixPQUFLLGlCQUFFLFFBQVEsRUFBRSxJQUFJLEVBQWU7UUFBYixNQUFNLHlEQUFHLEVBQUU7O0FBQ2hDLFdBQU8sb0JBQW9CLENBQUMsUUFBUSxDQUFDLENBQUE7R0FDdEM7QUFDRCxNQUFJLGdCQUFFLFFBQVEsRUFBZTtRQUFiLE1BQU0seURBQUcsRUFBRTs7QUFDekIsV0FBTyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsQ0FBQTtHQUNwQztBQUNELFVBQVEsb0JBQUUsUUFBUSxFQUFlO1FBQWIsTUFBTSx5REFBRyxFQUFFOztBQUM3QixXQUFPLHNCQUFzQixDQUFDLFFBQVEsQ0FBQyxDQUFBO0dBQ3hDO0FBQ0QsYUFBVyx5QkFBVztBQUNwQixXQUFPLFlBQVcsNEJBQVMsQ0FBQTtHQUM1QjtDQUNGLENBQUE7O0FBRUQsU0FBUyxrQkFBa0IsQ0FBRSxJQUFJLEVBQUU7QUFDakMsTUFBSSxRQUFRLElBQUkseUNBQUosSUFBSSxPQUFJLFFBQVEsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFNBQVMsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO0FBQ3hFLFdBQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUE7R0FDOUI7Q0FDRjs7QUFFRCxTQUFTLHNCQUFzQixDQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFO0FBQzVELE1BQUksWUFBWSxHQUFHLEtBQUssR0FBRyxLQUFLLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsU0FBUyxDQUFDLENBQUE7O0FBRXhFLFlBQVUsR0FBRyxVQUFVLElBQUksUUFBUSxDQUFDLFVBQVUsSUFBSSxDQUFDLENBQUE7O0FBRW5ELFNBQU87QUFDTCxXQUFPLG1CQUFFLE9BQU8sRUFBb0I7VUFBbEIsUUFBUSx5REFBRyxLQUFLOztBQUNoQyxVQUFJLEtBQUssR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsVUFuQ1YsT0FBTyxFQW1DVyxPQUFPLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQTtBQUM5RCxhQUFPLHNCQUFzQixDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQTtLQUMvQzs7Ozs7OztBQU9ELGtCQUFjLDBCQUFFLFdBQVcsRUFBRTtBQUN6QixVQUFHLFFBQVEsQ0FBQyxlQUFlLElBQUksUUFBUSxDQUFDLGVBQWUsQ0FBQyxjQUFjLEVBQUM7QUFDbkUsWUFBSSxHQUFHLEdBQUcsUUFBUSxDQUFDLGVBQWUsQ0FBQyxjQUFjLENBQUUsVUE5Q2xDLE9BQU8sRUE4Q21DLFdBQVcsQ0FBQyxDQUFFLENBQUE7O0FBRXpFLFlBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFO0FBQzNCLGlCQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtTQUMvQztPQUNKO0tBQ0o7O0FBRUQsUUFBSSxNQUFNLEdBQUk7QUFDWixhQUFPLGlCQUFpQixDQUFDLE1BQUssQ0FBQyxZQUFZLEVBQUUsRUFBQyxLQUFLLEVBQUUsVUFBVSxFQUFDLENBQUMsQ0FBQyxDQUFBO0tBQ25FO0FBQ0QsUUFBSSxRQUFRLEdBQUk7QUFDZCxhQUFPLGlCQUFpQixDQUFDLE1BQUssQ0FBQyxZQUFZLEVBQUUsRUFBQyxLQUFLLEVBQUUsVUFBVSxHQUFHLENBQUMsRUFBQyxDQUFDLENBQUMsQ0FBQTtLQUN2RTtBQUNELFFBQUksUUFBUSxHQUFJO0FBQ2QsYUFBTyxpQkFBaUIsQ0FBQyxNQUFLLENBQUMsWUFBWSxFQUFFLEVBQUMsS0FBSyxFQUFFLFVBQVUsR0FBRyxDQUFDLEVBQUMsQ0FBQyxDQUFDLENBQUE7S0FDdkU7QUFDRCxRQUFJLEtBQUssR0FBSTtBQUNYLFVBQUksTUFBTSxHQUFHLENBQUMsVUFBVSxHQUFHLENBQUMsRUFBRSxVQUFVLEdBQUcsQ0FBQyxFQUFFLFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQTtBQUM3RCxhQUFPLGlCQUFpQixDQUFDLE1BQUssQ0FBQyxZQUFZLEVBQUUsRUFBQyxLQUFLLEVBQUUsTUFBTSxFQUFDLENBQUMsQ0FBQyxDQUFBO0tBQy9EO0dBQ0YsQ0FBQTtDQUNGOztBQUVELFNBQVMsa0JBQWtCLENBQUUsUUFBUSxFQUFFO0FBQ3JDLE1BQUksTUFBTSxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFBO0FBQy9DLFNBQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUE7Q0FDN0M7O0FBRUQsU0FBUyxjQUFjLENBQUUsVUFBVSxFQUFFO0FBQ25DLE1BQUksUUFBUSxHQUFHLElBQUksQ0FBQTs7QUFFbkIsTUFBSSxDQUFDLEdBQUc7QUFDTixRQUFJLFNBQVMsR0FBSTtBQUNmLGFBQU8saUJBQWlCLENBQUMsVUFBVSxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFBO0tBQzVEO0FBQ0QsUUFBSSxHQUFHLEdBQUk7QUFDVCxhQUFPLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxDQUFBO0tBQ3JDOztBQUVELFFBQUksT0FBTyxHQUFJO0FBQ2IsYUFBTyxVQUFVLENBQUMsTUFBTSxDQUFDLFVBQUMsSUFBSSxFQUFFLEtBQUssRUFBSztBQUN4QyxTQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUEsQ0FBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7QUFDdkQsZUFBTyxJQUFJLENBQUE7T0FDWixFQUFFLEVBQUUsQ0FBQyxDQUFBO0tBQ1A7O0FBRUQsU0FBSyxpQkFBRSxPQUFPLEVBQWU7VUFBYixNQUFNLHlEQUFHLEVBQUU7O0FBQ3pCLFVBQUksT0FBTyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxVQTlGWixPQUFPLEVBOEZhLE9BQU8sQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUM7ZUFBSSxDQUFDLENBQUMsSUFBSSxLQUFLLE1BQU07T0FBQSxDQUFDLENBQUE7QUFDL0YsYUFBTyxpQkFBaUIsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUE7S0FDMUM7R0FDRixDQUFBOztBQUVELFlBQVUsQ0FBQyxHQUFHLENBQUMsVUFBQSxLQUFLO1dBQUksS0FBSyxDQUFDLElBQUk7R0FBQSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUEsSUFBSSxFQUFJO0FBQ2xELFFBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUU7QUFDWixZQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUU7QUFDN0IsV0FBRyxFQUFFLGVBQVk7QUFDZixpQkFBTyxpQkFBaUIsQ0FBQyxVQUFVLEVBQUUsRUFBQyxJQUFJLEVBQUosSUFBSSxFQUFDLENBQUMsSUFBSSxFQUFFLENBQUE7U0FDbkQ7T0FDRixDQUFDLENBQUE7S0FDSDtHQUNGLENBQUMsQ0FBQTs7QUFFRixTQUFPLENBQUMsQ0FBQTtDQUNUOztBQUVELFNBQVMsb0JBQW9CLENBQUUsUUFBUSxFQUFFO0FBQ3ZDLE1BQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFO0FBQUUsWUFBUSxDQUFDLE9BQU8sQ0FBQTtHQUFFOztBQUUzQyxNQUFJLEtBQUssR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUE7O0FBRS9DLE1BQUksS0FBSyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFBO0FBQ2xDLE1BQUksR0FBRyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFBOztBQUU5QixNQUFJLFVBQVUsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFBOztBQUUzQyxNQUFJLFFBQVEsR0FBRyxTQUFYLFFBQVEsQ0FBYSxFQUFFLEVBQUU7QUFDM0IsV0FBTyxRQUFRLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBRSxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUUsQ0FBQTtHQUM1QyxDQUFBOztBQUVELE1BQUksQ0FBQyxHQUFHO0FBQ04sU0FBSyxFQUFFLGlCQUF1QjtVQUFiLE1BQU0seURBQUcsRUFBRTs7QUFDMUIsYUFBTyxNQUFLLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUE7S0FDaEQ7QUFDRCxTQUFLLEVBQUUsZUFBVSxPQUFPLEVBQWU7VUFBYixNQUFNLHlEQUFHLEVBQUU7O0FBQ25DLFVBQUksT0FBTyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxVQW5JWixPQUFPLEVBbUlhLE9BQU8sQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFBO0FBQ2hFLGFBQU8saUJBQWlCLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFBO0tBQzFDO0FBQ0QsYUFBUyxFQUFFLG1CQUFVLE9BQU8sRUFBZTtVQUFiLE1BQU0seURBQUcsRUFBRTs7QUFDdkMsVUFBSSxXQUFXLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLFVBdkloQixPQUFPLEVBdUlpQixPQUFPLENBQUMsQ0FBQyxDQUFBO0FBQ3hELFVBQUksT0FBTyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxVQXhJakMsT0FBTyxFQXdJa0MsT0FBTyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQTs7QUFFdEYsYUFBTyxpQkFBaUIsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUE7S0FDMUM7QUFDRCxRQUFJLEVBQUUsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7QUFDL0IsTUFBRSxFQUFFO0FBQ0YsVUFBSSxFQUFFLFVBQVUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO0tBQ2hDO0FBQ0QsTUFBRSxFQUFFLFVBaEpDLE1BQU0sRUFnSkEsUUFBUSxFQUFFO0FBQ25CLFVBQUksRUFBRyxjQUFDLENBQUM7ZUFBSyxRQUFRLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUU7T0FBQSxBQUFDO0FBQ3BELFdBQUssRUFBRyxlQUFDLENBQUM7ZUFBSyxRQUFRLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7T0FBQSxBQUFDO0FBQzVDLFFBQUUsRUFBRSxRQUFRO0tBQ2IsQ0FBQztHQUNIOzs7QUFBQSxBQUdELE9BQUssQ0FBQyxPQUFPLENBQUMsVUFBQSxJQUFJLEVBQUk7QUFDcEIsVUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxHQUFHLEdBQUcsRUFBRTtBQUNuQyxnQkFBVSxFQUFFLEtBQUs7QUFDakIsU0FBRyxFQUFFLGVBQVk7QUFDZixlQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtPQUN4QjtLQUNGLENBQUMsQ0FBQTtHQUNILENBQUMsQ0FBQTs7QUFFRixTQUFPLENBQUMsQ0FBQTtDQUNUOztBQUVELFNBQVMsaUJBQWlCLENBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRTtBQUMzQyxNQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsVUFyS0YsT0FBTyxFQXFLRyxPQUFPLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQTtBQUMxRCxTQUFPLGlCQUFpQixDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQTtDQUN2Qzs7QUFHRCxTQUFTLFdBQVcsQ0FBRSxJQUFJLEVBQUUsTUFBTSxFQUFFO0FBQ2xDLE1BQUksS0FBSyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFBO0FBQ2pDLE1BQUksT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFBLENBQUUsR0FBRyxDQUFDLFVBQUEsT0FBTztXQUFJLEtBQUssQ0FBQyxPQUFPLENBQUM7R0FBQSxDQUFDLENBQUE7QUFDN0UsU0FBTyxpQkFBaUIsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUE7Q0FDMUM7O0FBRUQsU0FBUyxVQUFVLEdBQWU7TUFBYixNQUFNLHlEQUFHLEVBQUU7O0FBQzlCLE1BQUksS0FBSyxHQUFHLE1BQU0sQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUE7QUFDakQsU0FBTyxpQkFBaUIsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUE7Q0FDeEM7O0FBRUQsU0FBUyxNQUFLLENBQUUsUUFBUSxFQUFlO01BQWIsTUFBTSx5REFBRyxFQUFFOztBQUNuQyxTQUFPLFVBdExrRCxXQUFXLEVBc0xqRCxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUE7Q0FDckM7O0FBRUQsU0FBUyxXQUFXLENBQUUsSUFBSSxFQUFFO0FBQzFCLE1BQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFO0FBQ3JDLFFBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxNQUFNLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUU7QUFDbEYsYUFBTyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQTtLQUM5QjtHQUNGO0NBQ0Y7O0FBRUQsU0FBUyxPQUFPLENBQUUsR0FBRyxFQUFFO0FBQ3JCLE1BQUksUUFBUSxHQUFHLHlDQUFILEdBQUcsT0FBSSxRQUFRLElBQUksTUFBTSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsS0FBSyxRQUFRLEVBQUU7QUFDakYsV0FBTyxJQUFJLENBQUE7R0FDWjs7QUFFRCxTQUFPLEtBQUssQ0FBQTtDQUNiOztBQUVELFNBQVMsaUJBQWlCLENBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRTtBQUMzQyxNQUFJLFFBQVEsR0FBRyxNQUFLLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLENBQUMsRUFBRSxDQUFDO1dBQUssQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSztHQUFBLENBQUMsQ0FBQTs7QUFFdkUsWUE1TU8sTUFBTSxFQTRNTixRQUFRLEVBQUU7QUFDZixTQUFLLGlCQUFFLE1BQU0sRUFBRTtBQUNiLGFBQU8saUJBQWlCLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFBO0tBQzNDOztBQUNELFFBQUksUUFBUSxHQUFJO0FBQ2QsYUFBTyxVQWpOcUMsT0FBTyxFQWlOcEMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFBLElBQUk7ZUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUc7T0FBQSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7S0FDaEU7QUFDRCxRQUFJLEdBQUcsR0FBSTtBQUNULGFBQU8sVUFwTnFDLE9BQU8sRUFvTnBDLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBQSxJQUFJO2VBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHO09BQUEsQ0FBQyxDQUFDLENBQUE7S0FDckQ7QUFDRCxRQUFJLElBQUksR0FBSTtBQUNWLGFBQU8sUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFBLElBQUk7ZUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDO09BQUEsQ0FBQyxDQUFBO0tBQy9DO0FBQ0QsUUFBSSxLQUFLLEdBQUc7QUFDVixhQUFPLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQTtLQUNuQjtBQUNELFFBQUksSUFBSSxHQUFFO0FBQ1IsYUFBTyxRQUFRLENBQUUsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUUsQ0FBQTtLQUN2QztHQUNGLENBQUMsQ0FBQTs7QUFFRixTQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUMsVUFBQyxDQUFDLEVBQUMsQ0FBQztXQUFLLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUs7R0FBQSxDQUFDLENBQUE7Q0FDakQ7O0FBRUQsU0FBUyxXQUFXLENBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFO0FBQ3hELE1BQUksT0FBTyxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQTtBQUN6RCxNQUFJLFNBQVMsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQTtBQUNwRCxNQUFJLFNBQVMsSUFBSSxLQUFLLENBQUMsU0FBUyxDQUFDLEVBQUU7QUFDakMsV0FBTyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUE7R0FDeEI7Q0FDRjs7QUFFRCxTQUFTLGVBQWUsQ0FBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUU7QUFDNUQsTUFBSSxPQUFPLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFBO0FBQ3pELE1BQUksU0FBUyxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFBO0FBQ3BELE1BQUksU0FBUyxHQUFHLENBQUMsSUFBSSxTQUFTLElBQUksS0FBSyxDQUFDLFNBQVMsQ0FBQyxFQUFFO0FBQ2xELFdBQU8sS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0dBQ3hCO0NBQ0Y7O0FBRUQsU0FBUyxXQUFXLENBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsZUFBZSxFQUFFO0FBQ3ZELE1BQUksT0FBTyxHQUFHLGVBQWUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7O0FBRXRDLE1BQUksQ0FBQyxPQUFPLEVBQUU7QUFBRSxXQUFPLEVBQUUsQ0FBQTtHQUFFOztBQUUzQixNQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQUEsQ0FBQztXQUFJLEtBQUssQ0FBQyxDQUFDLENBQUM7R0FBQSxDQUFDLENBQUE7O0FBRXhDLFNBQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxVQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFLO0FBQzVDLFFBQUksS0FBSyxDQUFDLElBQUksS0FBSyxTQUFTLEVBQUU7QUFDNUIsVUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQTtBQUNoQixVQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsZUFBZSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsQ0FBQyxFQUFDLENBQUM7ZUFBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO09BQUEsQ0FBQyxDQUFDLENBQUE7S0FDckgsTUFBTTtBQUNMLFVBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7S0FDakI7QUFDRCxXQUFPLElBQUksQ0FBQTtHQUNaLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsQ0FBQyxFQUFDLENBQUM7V0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO0dBQUEsQ0FBQyxDQUFBO0NBQzVEOztBQUVELFNBQVMsa0JBQWtCLENBQUUsSUFBSSxFQUFFO0FBQ2pDLE1BQUksR0FBRyxHQUFHLEVBQUUsQ0FBQTs7QUFFWixNQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxVQUFBLFVBQVUsRUFBSTtBQUNyQyxRQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRTtBQUN6QixZQUFNLENBQUMsY0FBYyxDQUFDLEdBQUcsRUFBRSxVQUFVLENBQUMsSUFBSSxFQUFFO0FBQzFDLGtCQUFVLEVBQUUsS0FBSztBQUNqQixXQUFHLEVBQUUsZUFBWTtBQUFFLGlCQUFPLFVBQVUsQ0FBQTtTQUFFO09BQ3ZDLENBQUMsQ0FBQTtLQUNIO0dBQ0YsQ0FBQyxDQUFBOztBQUVGLFNBQU8sR0FBRyxDQUFBO0NBQ1g7O0FBRUQsU0FBUyxZQUFXLENBQUUsSUFBSSxFQUFnQjtNQUFkLE9BQU8seURBQUcsRUFBRTtNQUNoQyxLQUFLLEdBQWUsT0FBTyxDQUEzQixLQUFLO01BQUUsUUFBUSxHQUFLLE9BQU8sQ0FBcEIsUUFBUTswQkFDeUIsUUFBUSxDQUFDLE9BQU87TUFBeEQsR0FBRyxxQkFBSCxHQUFHO01BQUUsS0FBSyxxQkFBTCxLQUFLO01BQUUsTUFBTSxxQkFBTixNQUFNO01BQUUsZUFBZSxxQkFBZixlQUFlOztBQUV6QyxZQXpScUIsSUFBSSxFQXlScEIsSUFBSSxFQUFFLFFBQVEsRUFBRztXQUFNLEtBQUssQ0FBRSxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFFO0dBQUEsRUFBSSxLQUFLLENBQUMsQ0FBQTs7QUFFakUsUUEzUmUsSUFBSSxDQTJSZCxNQUFNLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRztXQUFNLFFBQVE7R0FBQSxDQUFFLENBQUE7O0FBRS9DLFlBN1JxQixJQUFJLEVBNlJwQixJQUFJLEVBQUUsT0FBTyxFQUFFLFlBQVk7QUFDOUIsV0FBTztBQUNMLFdBQUssRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJO0FBQy9CLFNBQUcsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJO0FBQzNCLFVBQUksR0FBRyxHQUFJO0FBQ1QsWUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFBO0FBQ3BDLFlBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQTtBQUNoQyxlQUFPLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUE7T0FDNUM7S0FDRixDQUFBO0dBQ0YsRUFBRSxLQUFLLENBQUMsQ0FBQTs7QUFFVCxNQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssU0FBUyxFQUFFO0FBQzNCLFVBMVNhLElBQUksQ0EwU1osUUFBUSxDQUFDLElBQUksRUFBRSxVQUFVLEVBQUUsRUFBRSxDQUFDOzs7QUFBQSxBQUduQyxjQTdTbUIsSUFBSSxFQTZTbEIsSUFBSSxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUc7YUFBTSxXQUFXLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsR0FBRyxDQUFDO0tBQUEsRUFBSSxLQUFLLENBQUM7OztBQUFBLEFBR2xGLGNBaFRtQixJQUFJLEVBZ1RsQixJQUFJLENBQUMsUUFBUSxFQUFFLFVBQVUsRUFBRzthQUFNLGVBQWUsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxHQUFHLENBQUM7S0FBQSxFQUFJLEtBQUssQ0FBQyxDQUFBOztBQUUxRixjQWxUbUIsSUFBSSxFQWtUbEIsSUFBSSxFQUFFLGFBQWEsRUFBRyxZQUFZO0FBQ3JDLGFBQU8sV0FBVyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLGVBQWUsQ0FBQyxDQUFBO0tBQ3RELEVBQUcsS0FBSyxDQUFDLENBQUE7O0FBRVYsY0F0VG1CLElBQUksRUFzVGxCLElBQUksRUFBRSxlQUFlLEVBQUcsWUFBWTtBQUN2QyxhQUFPLE1BQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQUMsSUFBSSxFQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLEVBQUMsQ0FBQyxDQUFBO0tBQ3hFLENBQUUsQ0FBQTs7QUFFSCxjQTFUbUIsSUFBSSxFQTBUbEIsSUFBSSxFQUFFLFlBQVksRUFBRyxZQUFZO0FBQ3BDLGFBQU8sTUFBSyxDQUFDLEtBQUssRUFBRSxFQUFDLElBQUksRUFBQyxXQUFXLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUMsQ0FBQyxDQUFBO0tBQzNELENBQUUsQ0FBQTs7QUFFSCxjQTlUbUIsSUFBSSxFQThUbEIsSUFBSSxFQUFFLFlBQVksRUFBRyxZQUFZO0FBQ3BDLGFBQU8sTUFBSyxDQUFDLEtBQUssRUFBRSxFQUFDLElBQUksRUFBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUMsQ0FBQyxDQUFBO0tBQ3RELENBQUUsQ0FBQTs7QUFFSCxjQWxVbUIsSUFBSSxFQWtVbEIsSUFBSSxFQUFFLE9BQU8sRUFBRyxZQUFZO0FBQy9CLGFBQU8sa0JBQWtCLENBQUMsSUFBSSxDQUFDLENBQUE7S0FDaEMsRUFBRyxLQUFLLENBQUMsQ0FBQTs7QUFFVixjQXRVSyxNQUFNLEVBc1VKLElBQUksRUFBRTtBQUNYLFdBQUssbUJBQVc7MENBQU4sSUFBSTtBQUFKLGNBQUk7OztBQUNaLGVBQU8sTUFBSyxtQkFBQyxJQUFJLENBQUMsV0FBVyxTQUFLLElBQUksRUFBQyxDQUFBO09BQ3hDO0tBQ0YsQ0FBQyxDQUFBO0dBQ0g7Q0FFRiIsImZpbGUiOiJxdWVyeV9pbnRlcmZhY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhc3NpZ24sIGhpZGUsIGxhenksIHNsdWdpZnksIHVuZGVyc2NvcmUsIGZsYXR0ZW4sIGZpbHRlclF1ZXJ5IH0gZnJvbSAnLi4vLi4vdXRpbCdcbi8qKlxuICogVGhlIERvY3VtZW50IFF1ZXJ5IEludGVyZmFjZSBkZWNvcmF0ZXMgdGhlIG5vZGVzIGluIG91ciBNYXJrZG93biBBU1Qgd2l0aFxuICogaGVscGVyIG1ldGhvZHMgd2hpY2ggY2FuIGJlIHVzZWQgdG8gaW5zcGVjdCB0aGUgY29udGVudCwgYW5kIHF1ZXJ5IHRoZSBkb2N1bWVudFxuICogdG8gZmluZCBjaGlsZCBub2Rlcywgc2libGluZyBub2RlcywgYW5kIG90aGVyIGluZm9ybWF0aW9uIHN1Y2ggYXMgbmVzdGVkIGNvZGUgYmxvY2tzXG4gKiB3aXRoIHRoZSBsYW5ndWFnZSBqYXZhc2NyaXB0LCBvciBhbnl0aGluZyBlbHNlLlxuICovXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgbm9kZXMgKGRvY3VtZW50LCB0eXBlLCBwYXJhbXMgPSB7fSkge1xuICAgIHJldHVybiBidWlsZEZpbHRlckludGVyZmFjZShkb2N1bWVudClcbiAgfSxcbiAgY29kZSAoZG9jdW1lbnQsIHBhcmFtcyA9IHt9KSB7XG4gICAgcmV0dXJuIGJ1aWxkQ29kZUludGVyZmFjZShkb2N1bWVudClcbiAgfSxcbiAgaGVhZGluZ3MgKGRvY3VtZW50LCBwYXJhbXMgPSB7fSkge1xuICAgIHJldHVybiBidWlsZEhlYWRpbmdzSW50ZXJmYWNlKGRvY3VtZW50KVxuICB9LFxuICBhcHBseVRvTm9kZSAoLi4uYXJncykge1xuICAgIHJldHVybiBhcHBseVRvTm9kZSguLi5hcmdzKVxuICB9XG59XG5cbmZ1bmN0aW9uIGV4dHJhY3RIZWFkaW5nVGV4dCAobm9kZSkge1xuICBpZiAodHlwZW9mIChub2RlKT09PSdvYmplY3QnICYmIG5vZGUudHlwZSA9PT0gJ2hlYWRpbmcnICYmIG5vZGUuY2hpbGRyZW4pIHtcbiAgICByZXR1cm4gbm9kZS5jaGlsZHJlblswXS52YWx1ZVxuICB9XG59XG5cbmZ1bmN0aW9uIGJ1aWxkSGVhZGluZ3NJbnRlcmZhY2UgKGRvY3VtZW50LCBzY29wZSwgdGl0bGVEZXB0aCkge1xuICBsZXQgaGVhZGluZ05vZGVzID0gc2NvcGUgPyBzY29wZSA6IG5vZGVzQnlUeXBlLmNhbGwoZG9jdW1lbnQsICdoZWFkaW5nJylcblxuICB0aXRsZURlcHRoID0gdGl0bGVEZXB0aCB8fCBkb2N1bWVudC5zdGFydERlcHRoIHx8IDFcblxuICByZXR1cm4ge1xuICAgIHNlY3Rpb24gKGhlYWRpbmcsIHJlbGF0aXZlID0gZmFsc2UpIHtcbiAgICAgIGxldCBub2RlcyA9IGRvY3VtZW50Lm5vZGVzLmF0LmlkKHNsdWdpZnkoaGVhZGluZykpLmRlc2NlbmRhbnRzXG4gICAgICByZXR1cm4gYnVpbGRIZWFkaW5nc0ludGVyZmFjZShkb2N1bWVudCwgbm9kZXMpXG4gICAgfSxcblxuICAgIC8qKlxuICAgICogRm9yIHNwZWNpYWxseSBuYW1lZCBzZWN0aW9ucyB3aGljaCBoYXZlIGFydGljbGVzLFxuICAgICogd2hhdCBhcmUgdGhleSBjYWxsZWQ/IHRoaXMgaXMgYSBjb252ZW5pZW5jZSBtZXRob2Qgc29cbiAgICAqIHdlIGNhbiBnZW5lcmF0ZSBjc3MgY2xhc3MgbmFtZXMgdG8gbWFrZSB0aGVtIGVhc2lseSBxdWVyeWFibGVcbiAgICAqL1xuICAgIGFydGljbGVOYW1lRm9yIChzZWN0aW9uTmFtZSkge1xuICAgICAgICBpZihkb2N1bWVudC5tb2RlbERlZmluaXRpb24gJiYgZG9jdW1lbnQubW9kZWxEZWZpbml0aW9uLnNlY3Rpb25zQ29uZmlnKXtcbiAgICAgICAgICAgIGxldCBjZmcgPSBkb2N1bWVudC5tb2RlbERlZmluaXRpb24uc2VjdGlvbnNDb25maWdbIHNsdWdpZnkoc2VjdGlvbk5hbWUpIF1cblxuICAgICAgICAgICAgaWYoY2ZnICYmIGNmZy5jb25maWcuYXJ0aWNsZXMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyhjZmcuY29uZmlnLmFydGljbGVzKVswXVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSxcblxuICAgIGdldCB0aXRsZXMgKCkge1xuICAgICAgcmV0dXJuIHdyYXBRdWVyeVJlc3BvbnNlKHF1ZXJ5KGhlYWRpbmdOb2Rlcywge2RlcHRoOiB0aXRsZURlcHRofSkpXG4gICAgfSxcbiAgICBnZXQgc2VjdGlvbnMgKCkge1xuICAgICAgcmV0dXJuIHdyYXBRdWVyeVJlc3BvbnNlKHF1ZXJ5KGhlYWRpbmdOb2Rlcywge2RlcHRoOiB0aXRsZURlcHRoICsgMX0pKVxuICAgIH0sXG4gICAgZ2V0IGFydGljbGVzICgpIHtcbiAgICAgIHJldHVybiB3cmFwUXVlcnlSZXNwb25zZShxdWVyeShoZWFkaW5nTm9kZXMsIHtkZXB0aDogdGl0bGVEZXB0aCArIDJ9KSlcbiAgICB9LFxuICAgIGdldCBtaW5vciAoKSB7XG4gICAgICBsZXQgZGVwdGhzID0gW3RpdGxlRGVwdGggKyAzLCB0aXRsZURlcHRoICsgNCwgdGl0bGVEZXB0aCArIDVdXG4gICAgICByZXR1cm4gd3JhcFF1ZXJ5UmVzcG9uc2UocXVlcnkoaGVhZGluZ05vZGVzLCB7ZGVwdGg6IGRlcHRoc30pKVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBidWlsZENvZGVJbnRlcmZhY2UgKGRvY3VtZW50KSB7XG4gIGxldCBibG9ja3MgPSBub2Rlc0J5VHlwZS5jYWxsKGRvY3VtZW50LCAnY29kZScpXG4gIHJldHVybiB3cmFwQ29kZUJsb2Nrcy5jYWxsKGRvY3VtZW50LCBibG9ja3MpXG59XG5cbmZ1bmN0aW9uIHdyYXBDb2RlQmxvY2tzIChjb2RlQmxvY2tzKSB7XG4gIGxldCBkb2N1bWVudCA9IHRoaXNcblxuICBsZXQgaSA9IHtcbiAgICBnZXQgbGFuZ3VhZ2VzICgpIHtcbiAgICAgIHJldHVybiB3cmFwUXVlcnlSZXNwb25zZShjb2RlQmxvY2tzKS5wbHVjaygnbGFuZycpLnVuaXF1ZSgpXG4gICAgfSxcbiAgICBnZXQgYWxsICgpIHtcbiAgICAgIHJldHVybiB3cmFwUXVlcnlSZXNwb25zZShjb2RlQmxvY2tzKVxuICAgIH0sXG5cbiAgICBnZXQgZ3JvdXBlZCAoKSB7XG4gICAgICByZXR1cm4gY29kZUJsb2Nrcy5yZWR1Y2UoKG1lbW8sIGJsb2NrKSA9PiB7XG4gICAgICAgIChtZW1vW2Jsb2NrLmxhbmddID0gbWVtb1tibG9jay5sYW5nXSB8fCBbXSkucHVzaChibG9jaylcbiAgICAgICAgcmV0dXJuIG1lbW9cbiAgICAgIH0sIHt9KVxuICAgIH0sXG5cbiAgICB1bmRlciAoaGVhZGluZywgcGFyYW1zID0ge30pIHtcbiAgICAgIGxldCByZXN1bHRzID0gZG9jdW1lbnQubm9kZXMuYXQuaWQoc2x1Z2lmeShoZWFkaW5nKSkuZGVzY2VuZGFudHMuZmlsdGVyKGIgPT4gYi50eXBlID09PSAnY29kZScpXG4gICAgICByZXR1cm4gd3JhcFF1ZXJ5UmVzcG9uc2UocmVzdWx0cywgcGFyYW1zKVxuICAgIH1cbiAgfVxuXG4gIGNvZGVCbG9ja3MubWFwKGJsb2NrID0+IGJsb2NrLmxhbmcpLmZvckVhY2gobGFuZyA9PiB7XG4gICAgaWYgKCFpW2xhbmddKSB7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoaSwgbGFuZywge1xuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICByZXR1cm4gd3JhcFF1ZXJ5UmVzcG9uc2UoY29kZUJsb2Nrcywge2xhbmd9KSB8fCBbXVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cbiAgfSlcblxuICByZXR1cm4gaVxufVxuXG5mdW5jdGlvbiBidWlsZEZpbHRlckludGVyZmFjZSAoZG9jdW1lbnQpIHtcbiAgaWYgKCFkb2N1bWVudC5pbmRleGVzKSB7IGRvY3VtZW50LmluZGV4ZWQgfVxuXG4gIGxldCB0eXBlcyA9IE9iamVjdC5rZXlzKGRvY3VtZW50LmluZGV4ZXMudHlwZXMpXG5cbiAgbGV0IGxpbmVzID0gZG9jdW1lbnQuaW5kZXhlcy5saW5lc1xuICBsZXQgaWRzID0gZG9jdW1lbnQuaW5kZXhlcy5pZHNcblxuICBsZXQgdHlwZUZpbHRlciA9IG5vZGVzQnlUeXBlLmJpbmQoZG9jdW1lbnQpXG5cbiAgbGV0IGZpbmRCeUlkID0gZnVuY3Rpb24gKGlkKSB7XG4gICAgcmV0dXJuIGRvY3VtZW50LmluZGV4ZWQuY2hpbGRyZW5bIGlkc1tpZF0gXVxuICB9XG5cbiAgbGV0IGkgPSB7XG4gICAgcXVlcnk6IGZ1bmN0aW9uIChwYXJhbXMgPSB7fSkge1xuICAgICAgcmV0dXJuIHF1ZXJ5KGRvY3VtZW50LmluZGV4ZWQuY2hpbGRyZW4sIHBhcmFtcylcbiAgICB9LFxuICAgIHVuZGVyOiBmdW5jdGlvbiAoaGVhZGluZywgcGFyYW1zID0ge30pIHtcbiAgICAgIGxldCByZXN1bHRzID0gZG9jdW1lbnQubm9kZXMuYXQuaWQoc2x1Z2lmeShoZWFkaW5nKSkuZGVzY2VuZGFudHNcbiAgICAgIHJldHVybiB3cmFwUXVlcnlSZXNwb25zZShyZXN1bHRzLCBwYXJhbXMpXG4gICAgfSxcbiAgICBpbmNsdWRpbmc6IGZ1bmN0aW9uIChoZWFkaW5nLCBwYXJhbXMgPSB7fSkge1xuICAgICAgbGV0IGhlYWRpbmdOb2RlID0gZG9jdW1lbnQubm9kZXMuYXQuaWQoc2x1Z2lmeShoZWFkaW5nKSlcbiAgICAgIGxldCByZXN1bHRzID0gW2hlYWRpbmdOb2RlXS5jb25jYXQoZG9jdW1lbnQubm9kZXMuYXQuaWQoc2x1Z2lmeShoZWFkaW5nKSkuZGVzY2VuZGFudHMpXG5cbiAgICAgIHJldHVybiB3cmFwUXVlcnlSZXNwb25zZShyZXN1bHRzLCBwYXJhbXMpXG4gICAgfSxcbiAgICB0eXBlOiB0eXBlRmlsdGVyLmJpbmQoZG9jdW1lbnQpLFxuICAgIG9mOiB7XG4gICAgICB0eXBlOiB0eXBlRmlsdGVyLmJpbmQoZG9jdW1lbnQpXG4gICAgfSxcbiAgICBhdDogYXNzaWduKGZpbmRCeUlkLCB7XG4gICAgICBsaW5lOiAoKGkpID0+IGRvY3VtZW50LmluZGV4ZWQuY2hpbGRyZW5bIGxpbmVzW2ldIF0pLFxuICAgICAgaW5kZXg6ICgoaSkgPT4gZG9jdW1lbnQuaW5kZXhlZC5jaGlsZHJlbltpXSksXG4gICAgICBpZDogZmluZEJ5SWRcbiAgICB9KVxuICB9XG5cbiAgLy8gZG9jdW1lbnQubm9kZXMuaGVhZGluZ3NcbiAgdHlwZXMuZm9yRWFjaCh0eXBlID0+IHtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoaSwgdHlwZSArICdzJywge1xuICAgICAgZW51bWVyYWJsZTogZmFsc2UsXG4gICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIHR5cGVGaWx0ZXIodHlwZSlcbiAgICAgIH1cbiAgICB9KVxuICB9KVxuXG4gIHJldHVybiBpXG59XG5cbmZ1bmN0aW9uIG5vZGVzVW5kZXJIZWFkaW5nIChoZWFkaW5nLCBwYXJhbXMpIHtcbiAgbGV0IG5vZGVzID0gdGhpcy5ub2Rlcy5hdC5pZChzbHVnaWZ5KGhlYWRpbmcpKS5kZXNjZW5kYW50c1xuICByZXR1cm4gd3JhcFF1ZXJ5UmVzcG9uc2Uobm9kZSwgcGFyYW1zKVxufVxuXG5cbmZ1bmN0aW9uIG5vZGVzQnlUeXBlICh0eXBlLCBwYXJhbXMpIHtcbiAgbGV0IG5vZGVzID0gdGhpcy5pbmRleGVkLmNoaWxkcmVuXG4gIGxldCByZXN1bHRzID0gKHRoaXMuaW5kZXhlcy50eXBlc1t0eXBlXSB8fCBbXSkubWFwKHBvaW50ZXIgPT4gbm9kZXNbcG9pbnRlcl0pXG4gIHJldHVybiB3cmFwUXVlcnlSZXNwb25zZShyZXN1bHRzLCBwYXJhbXMpXG59XG5cbmZ1bmN0aW9uIHF1ZXJ5Tm9kZXMgKHBhcmFtcyA9IHt9KSB7XG4gIGxldCBub2RlcyA9IHBhcmFtcy5ub2RlcyB8fCB0aGlzLmluZGV4ZWQuY2hpbGRyZW5cbiAgcmV0dXJuIHdyYXBRdWVyeVJlc3BvbnNlKG5vZGVzLCBwYXJhbXMpXG59XG5cbmZ1bmN0aW9uIHF1ZXJ5IChub2RlTGlzdCwgcGFyYW1zID0ge30pIHtcbiAgcmV0dXJuIGZpbHRlclF1ZXJ5KG5vZGVMaXN0LCBwYXJhbXMpXG59XG5cbmZ1bmN0aW9uIGV4dHJhY3RUZXh0IChub2RlKSB7XG4gIGlmIChub2RlLmNoaWxkcmVuICYmIG5vZGUuY2hpbGRyZW5bMF0pIHtcbiAgICBpZiAobm9kZS5jaGlsZHJlblswXSAmJiBub2RlLmNoaWxkcmVuWzBdLnR5cGUgPT09ICd0ZXh0JyAmJiBub2RlLmNoaWxkcmVuWzBdLnZhbHVlKSB7XG4gICAgICByZXR1cm4gbm9kZS5jaGlsZHJlblswXS52YWx1ZVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBpc1JlZ2V4ICh2YWwpIHtcbiAgaWYgKHR5cGVvZiAodmFsKT09PSdvYmplY3QnICYmIE9iamVjdC5nZXRQcm90b3R5cGVPZih2YWwpLnRvU3RyaW5nKCkgPT09ICcvKD86KS8nKSB7XG4gICAgcmV0dXJuIHRydWVcbiAgfVxuXG4gIHJldHVybiBmYWxzZVxufVxuXG5mdW5jdGlvbiB3cmFwUXVlcnlSZXNwb25zZSAocmVzdWx0cywgcGFyYW1zKSB7XG4gIGxldCByZXNwb25zZSA9IHF1ZXJ5KHJlc3VsdHMsIHBhcmFtcykuc29ydCgoYSwgYikgPT4gYS5pbmRleCAtIGIuaW5kZXgpXG5cbiAgYXNzaWduKHJlc3BvbnNlLCB7XG4gICAgcXVlcnkgKHBhcmFtcykge1xuICAgICAgcmV0dXJuIHdyYXBRdWVyeVJlc3BvbnNlKHJlc3BvbnNlLCBwYXJhbXMpXG4gICAgfSxcbiAgICBnZXQgbWFya2Rvd24gKCkge1xuICAgICAgcmV0dXJuIGZsYXR0ZW4ocmVzcG9uc2UubWFwKG5vZGUgPT4gbm9kZS5saW5lcy5yYXcpKS5qb2luKCdcXG4nKVxuICAgIH0sXG4gICAgZ2V0IHJhdyAoKSB7XG4gICAgICByZXR1cm4gZmxhdHRlbihyZXNwb25zZS5tYXAobm9kZSA9PiBub2RlLmxpbmVzLnJhdykpXG4gICAgfSxcbiAgICBnZXQgdGV4dCAoKSB7XG4gICAgICByZXR1cm4gcmVzcG9uc2UubWFwKG5vZGUgPT4gZXh0cmFjdFRleHQobm9kZSkpXG4gICAgfSxcbiAgICBnZXQgZmlyc3QoKSB7XG4gICAgICByZXR1cm4gcmVzcG9uc2VbMF1cbiAgICB9LFxuICAgIGdldCBsYXN0KCl7XG4gICAgICByZXR1cm4gcmVzcG9uc2VbIHJlc3BvbnNlLmxlbmd0aCAtIDEgXVxuICAgIH1cbiAgfSlcblxuICByZXR1cm4gcmVzcG9uc2Uuc29ydCgoYSxiKSA9PiBhLmluZGV4IC0gYi5pbmRleClcbn1cblxuZnVuY3Rpb24gbmV4dFNpYmxpbmcgKG5vZGUsIG5vZGVzLCBkZXB0aHNJbmRleCwgaWRzSW5kZXgpIHtcbiAgbGV0IG15SW5kZXggPSBkZXB0aHNJbmRleFtub2RlLmRlcHRoXS5pbmRleE9mKG5vZGUuaW5kZXgpXG4gIGxldCBuZXh0SW5kZXggPSBkZXB0aHNJbmRleFtub2RlLmRlcHRoXVtteUluZGV4ICsgMV1cbiAgaWYgKG5leHRJbmRleCAmJiBub2Rlc1tuZXh0SW5kZXhdKSB7XG4gICAgcmV0dXJuIG5vZGVzW25leHRJbmRleF1cbiAgfVxufVxuXG5mdW5jdGlvbiBwcmV2aW91c1NpYmxpbmcgKG5vZGUsIG5vZGVzLCBkZXB0aHNJbmRleCwgaWRzSW5kZXgpIHtcbiAgbGV0IG15SW5kZXggPSBkZXB0aHNJbmRleFtub2RlLmRlcHRoXS5pbmRleE9mKG5vZGUuaW5kZXgpXG4gIGxldCBuZXh0SW5kZXggPSBkZXB0aHNJbmRleFtub2RlLmRlcHRoXVtteUluZGV4IC0gMV1cbiAgaWYgKG5leHRJbmRleCA+IDAgJiYgbmV4dEluZGV4ICYmIG5vZGVzW25leHRJbmRleF0pIHtcbiAgICByZXR1cm4gbm9kZXNbbmV4dEluZGV4XVxuICB9XG59XG5cbmZ1bmN0aW9uIGFsbENoaWxkcmVuIChub2RlLCBub2RlcywgaWRzLCBjaGlsZHJlbkluZGV4ZXMpIHtcbiAgbGV0IGluZGV4ZXMgPSBjaGlsZHJlbkluZGV4ZXNbbm9kZS5pZF1cblxuICBpZiAoIWluZGV4ZXMpIHsgcmV0dXJuIFtdIH1cblxuICBsZXQgcmVzdWx0cyA9IGluZGV4ZXMubWFwKGkgPT4gbm9kZXNbaV0pXG5cbiAgcmV0dXJuIHJlc3VsdHMucmVkdWNlKChtZW1vLCBjaGlsZCwgaW5kZXgpID0+IHtcbiAgICBpZiAoY2hpbGQudHlwZSA9PT0gJ2hlYWRpbmcnKSB7XG4gICAgICBtZW1vLnB1c2goY2hpbGQpXG4gICAgICBtZW1vID0gbWVtby5jb25jYXQoYWxsQ2hpbGRyZW4oY2hpbGQsIG5vZGVzLCBpZHMsIGNoaWxkcmVuSW5kZXhlcykuc29ydCgoYSxiKT0+cGFyc2VJbnQoYS5pbmRleCktcGFyc2VJbnQoYi5pbmRleCkpKVxuICAgIH0gZWxzZSB7XG4gICAgICBtZW1vLnB1c2goY2hpbGQpXG4gICAgfVxuICAgIHJldHVybiBtZW1vXG4gIH0sIFtdKS5zb3J0KChhLGIpID0+IHBhcnNlSW50KGEuaW5kZXgpIC0gcGFyc2VJbnQoYi5pbmRleCkpXG59XG5cbmZ1bmN0aW9uIGZpcnN0VHlwZUludGVyZmFjZSAobm9kZSkge1xuICBsZXQgb2JqID0ge31cblxuICBub2RlLmRlc2NlbmRhbnRzLmZvckVhY2goZGVzY2VuZGFudCA9PiB7XG4gICAgaWYgKCFvYmpbZGVzY2VuZGFudC50eXBlXSkge1xuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwgZGVzY2VuZGFudC50eXBlLCB7XG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIGRlc2NlbmRhbnQgfVxuICAgICAgfSlcbiAgICB9XG4gIH0pXG5cbiAgcmV0dXJuIG9ialxufVxuXG5mdW5jdGlvbiBhcHBseVRvTm9kZSAobm9kZSwgb3B0aW9ucyA9IHt9KSB7XG4gIGxldCB7IG5vZGVzLCBkb2N1bWVudCB9ID0gb3B0aW9uc1xuICBsZXQgeyBpZHMsIHR5cGVzLCBkZXB0aHMsIGNoaWxkcmVuSW5kZXhlcyB9ID0gZG9jdW1lbnQuaW5kZXhlc1xuXG4gIGxhenkobm9kZSwgJ3BhcmVudCcsICgoKSA9PiBub2Rlc1sgaWRzW25vZGUucGFyZW50SWRdIF0gKSwgZmFsc2UpXG5cbiAgaGlkZS5nZXR0ZXIobm9kZSwgJ2RvY3VtZW50JywgKCgpID0+IGRvY3VtZW50KSlcblxuICBsYXp5KG5vZGUsICdsaW5lcycsIGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhcnQ6IG5vZGUucG9zaXRpb24uc3RhcnQubGluZSxcbiAgICAgIGVuZDogbm9kZS5wb3NpdGlvbi5lbmQubGluZSxcbiAgICAgIGdldCByYXcgKCkge1xuICAgICAgICBsZXQgc3RhcnQgPSBub2RlLnBvc2l0aW9uLnN0YXJ0LmxpbmVcbiAgICAgICAgbGV0IGVuZCA9IG5vZGUucG9zaXRpb24uZW5kLmxpbmVcbiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmxpbmVzLnNsaWNlKHN0YXJ0IC0gMSwgZW5kKVxuICAgICAgfVxuICAgIH1cbiAgfSwgZmFsc2UpXG5cbiAgaWYgKG5vZGUudHlwZSA9PT0gJ2hlYWRpbmcnKSB7XG4gICAgaGlkZS5wcm9wZXJ0eShub2RlLCAnc2libGluZ3MnLCB7fSlcblxuICAgIC8vIG5vZGUuc2libGluZ3MubmV4dFxuICAgIGxhenkobm9kZS5zaWJsaW5ncywgJ25leHQnLCAoKCkgPT4gbmV4dFNpYmxpbmcobm9kZSwgbm9kZXMsIGRlcHRocywgaWRzKSApLCBmYWxzZSlcblxuICAgIC8vIG5vZGUuc2libGluZ3MucHJldmlvdXNcbiAgICBsYXp5KG5vZGUuc2libGluZ3MsICdwcmV2aW91cycsICgoKSA9PiBwcmV2aW91c1NpYmxpbmcobm9kZSwgbm9kZXMsIGRlcHRocywgaWRzKSApLCBmYWxzZSlcblxuICAgIGxhenkobm9kZSwgJ2Rlc2NlbmRhbnRzJywgKGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBhbGxDaGlsZHJlbihub2RlLCBub2RlcywgaWRzLCBjaGlsZHJlbkluZGV4ZXMpXG4gICAgfSksIGZhbHNlKVxuXG4gICAgbGF6eShub2RlLCAnY2hpbGRIZWFkaW5ncycsIChmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gcXVlcnkobm9kZS5kZXNjZW5kYW50cywge3R5cGU6J2hlYWRpbmcnLCBkZXB0aDogbm9kZS5kZXB0aCArIDF9KVxuICAgIH0pKVxuXG4gICAgbGF6eShub2RlLCAncGFyYWdyYXBocycsIChmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gcXVlcnkobm9kZXMsIHt0eXBlOidwYXJhZ3JhcGgnLCBwYXJlbnRJZDogbm9kZS5pZH0pXG4gICAgfSkpXG5cbiAgICBsYXp5KG5vZGUsICdjb2RlQmxvY2tzJywgKGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBxdWVyeShub2Rlcywge3R5cGU6J2NvZGUnLCBwYXJlbnRJZDogbm9kZS5pZH0pXG4gICAgfSkpXG5cbiAgICBsYXp5KG5vZGUsICdmaXJzdCcsIChmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gZmlyc3RUeXBlSW50ZXJmYWNlKG5vZGUpXG4gICAgfSksIGZhbHNlKVxuXG4gICAgYXNzaWduKG5vZGUsIHtcbiAgICAgIHF1ZXJ5ICguLi5yZXN0KSB7XG4gICAgICAgIHJldHVybiBxdWVyeShub2RlLmRlc2NlbmRhbnRzLCAuLi5yZXN0KVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxufVxuXG4iXX0=