'use strict';

var _util = require('../../util');

function _typeof(obj) { return obj && typeof Symbol !== "undefined" && obj.constructor === Symbol ? "symbol" : typeof obj; }

/**
 * The Document Query Interface decorates the nodes in our Markdown AST with
 * helper methods which can be used to inspect the content, and query the document
 * to find child nodes, sibling nodes, and other information such as nested code blocks
 * with the language javascript, or anything else.
 */
module.exports = {
  nodes: function nodes(document, type) {
    var params = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];

    return buildFilterInterface(document);
  },
  code: function code(document) {
    var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

    return buildCodeInterface(document);
  },
  headings: function headings(document) {
    var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

    return buildHeadingsInterface(document);
  },
  applyToNode: function applyToNode() {
    return _applyToNode.apply(undefined, arguments);
  }
};

function extractHeadingText(node) {
  if ((typeof node === 'undefined' ? 'undefined' : _typeof(node)) === 'object' && node.type === 'heading' && node.children) {
    return node.children[0].value;
  }
}

function buildHeadingsInterface(document, scope, titleDepth) {
  var headingNodes = scope ? scope : nodesByType.call(document, 'heading');

  titleDepth = titleDepth || document.startDepth || 1;

  return {
    section: function section(heading) {
      var relative = arguments.length <= 1 || arguments[1] === undefined ? false : arguments[1];

      var nodes = document.nodes.at.id((0, _util.slugify)(heading)).descendants;
      return buildHeadingsInterface(document, nodes);
    },

    /**
    * For specially named sections which have articles,
    * what are they called? this is a convenience method so
    * we can generate css class names to make them easily queryable
    */
    articleNameFor: function articleNameFor(sectionName) {
      if (document.modelDefinition && document.modelDefinition.sectionsConfig) {
        var cfg = document.modelDefinition.sectionsConfig[(0, _util.slugify)(sectionName)];

        if (cfg && cfg.config.articles) {
          return Object.values(cfg.config.articles)[0];
        }
      }
    },

    get titles() {
      return wrapQueryResponse(_query(headingNodes, { depth: titleDepth }));
    },
    get sections() {
      return wrapQueryResponse(_query(headingNodes, { depth: titleDepth + 1 }));
    },
    get articles() {
      return wrapQueryResponse(_query(headingNodes, { depth: titleDepth + 2 }));
    },
    get minor() {
      var depths = [titleDepth + 3, titleDepth + 4, titleDepth + 5];
      return wrapQueryResponse(_query(headingNodes, { depth: depths }));
    }
  };
}

function buildCodeInterface(document) {
  var blocks = nodesByType.call(document, 'code');
  return wrapCodeBlocks.call(document, blocks);
}

function wrapCodeBlocks(codeBlocks) {
  var document = this;

  var i = {
    get languages() {
      return wrapQueryResponse(codeBlocks).pluck('lang').unique();
    },
    get all() {
      return wrapQueryResponse(codeBlocks);
    },

    get grouped() {
      return codeBlocks.reduce(function (memo, block) {
        (memo[block.lang] = memo[block.lang] || []).push(block);
        return memo;
      }, {});
    },

    under: function under(heading) {
      var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

      var results = document.nodes.at.id((0, _util.slugify)(heading)).descendants.filter(function (b) {
        return b.type === 'code';
      });
      return wrapQueryResponse(results, params);
    }
  };

  codeBlocks.map(function (block) {
    return block.lang;
  }).forEach(function (lang) {
    if (!i[lang]) {
      Object.defineProperty(i, lang, {
        get: function get() {
          return wrapQueryResponse(codeBlocks, { lang: lang }) || [];
        }
      });
    }
  });

  return i;
}

function buildFilterInterface(document) {
  if (!document.indexes) {
    document.indexed;
  }

  var types = Object.keys(document.indexes.types);

  var lines = document.indexes.lines;
  var ids = document.indexes.ids;

  var typeFilter = nodesByType.bind(document);

  var findById = function findById(id) {
    return document.indexed.children[ids[id]];
  };

  var i = {
    query: function query() {
      var params = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

      return _query(document.indexed.children, params);
    },
    under: function under(heading) {
      var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

      var results = document.nodes.at.id((0, _util.slugify)(heading)).descendants;
      return wrapQueryResponse(results, params);
    },
    including: function including(heading) {
      var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

      var headingNode = document.nodes.at.id((0, _util.slugify)(heading));
      var results = [headingNode].concat(document.nodes.at.id((0, _util.slugify)(heading)).descendants);

      return wrapQueryResponse(results, params);
    },
    type: typeFilter.bind(document),
    of: {
      type: typeFilter.bind(document)
    },
    at: (0, _util.assign)(findById, {
      line: function line(i) {
        return document.indexed.children[lines[i]];
      },
      index: function index(i) {
        return document.indexed.children[i];
      },
      id: findById
    })
  };

  // document.nodes.headings
  types.forEach(function (type) {
    Object.defineProperty(i, type + 's', {
      enumerable: false,
      get: function get() {
        return typeFilter(type);
      }
    });
  });

  return i;
}

function nodesUnderHeading(heading, params) {
  var nodes = this.nodes.at.id((0, _util.slugify)(heading)).descendants;
  return wrapQueryResponse(node, params);
}

function nodesByType(type, params) {
  var nodes = this.indexed.children;
  var results = (this.indexes.types[type] || []).map(function (pointer) {
    return nodes[pointer];
  });
  return wrapQueryResponse(results, params);
}

function queryNodes() {
  var params = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

  var nodes = params.nodes || this.indexed.children;
  return wrapQueryResponse(nodes, params);
}

function _query(nodeList) {
  var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  return (0, _util.filterQuery)(nodeList, params);
}

function extractText(node) {
  if (node.children && node.children[0]) {
    if (node.children[0] && node.children[0].type === 'text' && node.children[0].value) {
      return node.children[0].value;
    }
  }
}

function isRegex(val) {
  if ((typeof val === 'undefined' ? 'undefined' : _typeof(val)) === 'object' && Object.getPrototypeOf(val).toString() === '/(?:)/') {
    return true;
  }

  return false;
}

function wrapQueryResponse(results, params) {
  var response = _query(results, params).sort(function (a, b) {
    return a.index - b.index;
  });

  (0, _util.assign)(response, {
    query: function query(params) {
      return wrapQueryResponse(response, params);
    },

    get markdown() {
      return (0, _util.flatten)(response.map(function (node) {
        return node.lines && node.lines.raw;
      })).join('\n');
    },
    get raw() {
      return (0, _util.flatten)(response.map(function (node) {
        return node.lines && node.lines.raw;
      }));
    },
    get text() {
      return response.map(function (node) {
        return extractText(node);
      });
    },
    get first() {
      return response[0];
    },
    get last() {
      return response[response.length - 1];
    }
  });

  return response.sort(function (a, b) {
    return a.index - b.index;
  });
}

function nextSibling(node, nodes, depthsIndex, idsIndex) {
  var myIndex = depthsIndex[node.depth].indexOf(node.index);
  var nextIndex = depthsIndex[node.depth][myIndex + 1];
  if (nextIndex && nodes[nextIndex]) {
    return nodes[nextIndex];
  }
}

function previousSibling(node, nodes, depthsIndex, idsIndex) {
  var myIndex = depthsIndex[node.depth].indexOf(node.index);
  var nextIndex = depthsIndex[node.depth][myIndex - 1];
  if (nextIndex > 0 && nextIndex && nodes[nextIndex]) {
    return nodes[nextIndex];
  }
}

function allChildren(node, nodes, ids, childrenIndexes) {
  var indexes = childrenIndexes[node.id];

  if (!indexes) {
    return [];
  }

  var results = indexes.map(function (i) {
    return nodes[i];
  });

  return results.reduce(function (memo, child, index) {
    if (child.type === 'heading') {
      memo.push(child);
      memo = memo.concat(allChildren(child, nodes, ids, childrenIndexes).sort(function (a, b) {
        return parseInt(a.index) - parseInt(b.index);
      }));
    } else {
      memo.push(child);
    }
    return memo;
  }, []).sort(function (a, b) {
    return parseInt(a.index) - parseInt(b.index);
  });
}

function firstTypeInterface(node) {
  var obj = {};

  node.descendants.forEach(function (descendant) {
    if (!obj[descendant.type]) {
      Object.defineProperty(obj, descendant.type, {
        enumerable: false,
        get: function get() {
          return descendant;
        }
      });
    }
  });

  return obj;
}

function _applyToNode(node) {
  var options = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  var nodes = options.nodes;
  var document = options.document;
  var _document$indexes = document.indexes;
  var ids = _document$indexes.ids;
  var types = _document$indexes.types;
  var depths = _document$indexes.depths;
  var childrenIndexes = _document$indexes.childrenIndexes;

  (0, _util.lazy)(node, 'parent', function () {
    return nodes[ids[node.parentId]];
  }, false);

  _util.hide.getter(node, 'document', function () {
    return document;
  });

  (0, _util.lazy)(node, 'lines', function () {
    return {
      start: node.position.start.line,
      end: node.position.end.line,
      get raw() {
        var start = node.position.start.line;
        var end = node.position.end.line;
        return document.lines.slice(start - 1, end);
      }
    };
  }, false);

  if (node.type === 'heading') {
    _util.hide.property(node, 'siblings', {});

    // node.siblings.next
    (0, _util.lazy)(node.siblings, 'next', function () {
      return nextSibling(node, nodes, depths, ids);
    }, false);

    // node.siblings.previous
    (0, _util.lazy)(node.siblings, 'previous', function () {
      return previousSibling(node, nodes, depths, ids);
    }, false);

    (0, _util.lazy)(node, 'descendants', function () {
      return allChildren(node, nodes, ids, childrenIndexes);
    }, false);

    (0, _util.lazy)(node, 'childHeadings', function () {
      return _query(node.descendants, { type: 'heading', depth: node.depth + 1 });
    });

    (0, _util.lazy)(node, 'paragraphs', function () {
      return _query(nodes, { type: 'paragraph', parentId: node.id });
    });

    (0, _util.lazy)(node, 'codeBlocks', function () {
      return _query(nodes, { type: 'code', parentId: node.id });
    });

    (0, _util.lazy)(node, 'first', function () {
      return firstTypeInterface(node);
    }, false);

    (0, _util.assign)(node, {
      query: function query() {
        for (var _len = arguments.length, rest = Array(_len), _key = 0; _key < _len; _key++) {
          rest[_key] = arguments[_key];
        }

        return _query.apply(undefined, [node.descendants].concat(rest));
      }
    });
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hc3NldHMvZG9jdW1lbnQvcXVlcnlfaW50ZXJmYWNlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQU9BLE1BQU0sQ0FBQyxPQUFPLEdBQUc7QUFDZixPQUFLLGlCQUFFLFFBQVEsRUFBRSxJQUFJLEVBQWU7UUFBYixNQUFNLHlEQUFHLEVBQUU7O0FBQ2hDLFdBQU8sb0JBQW9CLENBQUMsUUFBUSxDQUFDLENBQUE7R0FDdEM7QUFDRCxNQUFJLGdCQUFFLFFBQVEsRUFBZTtRQUFiLE1BQU0seURBQUcsRUFBRTs7QUFDekIsV0FBTyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsQ0FBQTtHQUNwQztBQUNELFVBQVEsb0JBQUUsUUFBUSxFQUFlO1FBQWIsTUFBTSx5REFBRyxFQUFFOztBQUM3QixXQUFPLHNCQUFzQixDQUFDLFFBQVEsQ0FBQyxDQUFBO0dBQ3hDO0FBQ0QsYUFBVyx5QkFBVztBQUNwQixXQUFPLFlBQVcsNEJBQVMsQ0FBQTtHQUM1QjtDQUNGLENBQUE7O0FBRUQsU0FBUyxrQkFBa0IsQ0FBRSxJQUFJLEVBQUU7QUFDakMsTUFBSSxRQUFRLElBQUkseUNBQUosSUFBSSxPQUFJLFFBQVEsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFNBQVMsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO0FBQ3hFLFdBQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUE7R0FDOUI7Q0FDRjs7QUFFRCxTQUFTLHNCQUFzQixDQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFO0FBQzVELE1BQUksWUFBWSxHQUFHLEtBQUssR0FBRyxLQUFLLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsU0FBUyxDQUFDLENBQUE7O0FBRXhFLFlBQVUsR0FBRyxVQUFVLElBQUksUUFBUSxDQUFDLFVBQVUsSUFBSSxDQUFDLENBQUE7O0FBRW5ELFNBQU87QUFDTCxXQUFPLG1CQUFF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LElBQUksRUFBRSxZQUFZLEVBQUcsWUFBWTtBQUNwQyxhQUFPLE1BQUssQ0FBQyxLQUFLLEVBQUUsRUFBQyxJQUFJLEVBQUMsV0FBVyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFDLENBQUMsQ0FBQTtLQUMzRCxDQUFFLENBQUE7O0FBRUgsY0E5VG1CLElBQUksRUE4VGxCLElBQUksRUFBRSxZQUFZLEVBQUcsWUFBWTtBQUNwQyxhQUFPLE1BQUssQ0FBQyxLQUFLLEVBQUUsRUFBQyxJQUFJLEVBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFDLENBQUMsQ0FBQTtLQUN0RCxDQUFFLENBQUE7O0FBRUgsY0FsVW1CLElBQUksRUFrVWxCLElBQUksRUFBRSxPQUFPLEVBQUcsWUFBWTtBQUMvQixhQUFPLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFBO0tBQ2hDLEVBQUcsS0FBSyxDQUFDLENBQUE7O0FBRVYsY0F0VUssTUFBTSxFQXNVSixJQUFJLEVBQUU7QUFDWCxXQUFLLG1CQUFXOzBDQUFOLElBQUk7QUFBSixjQUFJOzs7QUFDWixlQUFPLE1BQUssbUJBQUMsSUFBSSxDQUFDLFdBQVcsU0FBSyxJQUFJLEVBQUMsQ0FBQTtPQUN4QztLQUNGLENBQUMsQ0FBQTtHQUNIO0NBRUYiLCJmaWxlIjoicXVlcnlfaW50ZXJmYWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYXNzaWduLCBoaWRlLCBsYXp5LCBzbHVnaWZ5LCB1bmRlcnNjb3JlLCBmbGF0dGVuLCBmaWx0ZXJRdWVyeSB9IGZyb20gJy4uLy4uL3V0aWwnXG4vKipcbiAqIFRoZSBEb2N1bWVudCBRdWVyeSBJbnRlcmZhY2UgZGVjb3JhdGVzIHRoZSBub2RlcyBpbiBvdXIgTWFya2Rvd24gQVNUIHdpdGhcbiAqIGhlbHBlciBtZXRob2RzIHdoaWNoIGNhbiBiZSB1c2VkIHRvIGluc3BlY3QgdGhlIGNvbnRlbnQsIGFuZCBxdWVyeSB0aGUgZG9jdW1lbnRcbiAqIHRvIGZpbmQgY2hpbGQgbm9kZXMsIHNpYmxpbmcgbm9kZXMsIGFuZCBvdGhlciBpbmZvcm1hdGlvbiBzdWNoIGFzIG5lc3RlZCBjb2RlIGJsb2Nrc1xuICogd2l0aCB0aGUgbGFuZ3VhZ2UgamF2YXNjcmlwdCwgb3IgYW55dGhpbmcgZWxzZS5cbiAqL1xubW9kdWxlLmV4cG9ydHMgPSB7XG4gIG5vZGVzIChkb2N1bWVudCwgdHlwZSwgcGFyYW1zID0ge30pIHtcbiAgICByZXR1cm4gYnVpbGRGaWx0ZXJJbnRlcmZhY2UoZG9jdW1lbnQpXG4gIH0sXG4gIGNvZGUgKGRvY3VtZW50LCBwYXJhbXMgPSB7fSkge1xuICAgIHJldHVybiBidWlsZENvZGVJbnRlcmZhY2UoZG9jdW1lbnQpXG4gIH0sXG4gIGhlYWRpbmdzIChkb2N1bWVudCwgcGFyYW1zID0ge30pIHtcbiAgICByZXR1cm4gYnVpbGRIZWFkaW5nc0ludGVyZmFjZShkb2N1bWVudClcbiAgfSxcbiAgYXBwbHlUb05vZGUgKC4uLmFyZ3MpIHtcbiAgICByZXR1cm4gYXBwbHlUb05vZGUoLi4uYXJncylcbiAgfVxufVxuXG5mdW5jdGlvbiBleHRyYWN0SGVhZGluZ1RleHQgKG5vZGUpIHtcbiAgaWYgKHR5cGVvZiAobm9kZSk9PT0nb2JqZWN0JyAmJiBub2RlLnR5cGUgPT09ICdoZWFkaW5nJyAmJiBub2RlLmNoaWxkcmVuKSB7XG4gICAgcmV0dXJuIG5vZGUuY2hpbGRyZW5bMF0udmFsdWVcbiAgfVxufVxuXG5mdW5jdGlvbiBidWlsZEhlYWRpbmdzSW50ZXJmYWNlIChkb2N1bWVudCwgc2NvcGUsIHRpdGxlRGVwdGgpIHtcbiAgbGV0IGhlYWRpbmdOb2RlcyA9IHNjb3BlID8gc2NvcGUgOiBub2Rlc0J5VHlwZS5jYWxsKGRvY3VtZW50LCAnaGVhZGluZycpXG5cbiAgdGl0bGVEZXB0aCA9IHRpdGxlRGVwdGggfHwgZG9jdW1lbnQuc3RhcnREZXB0aCB8fCAxXG5cbiAgcmV0dXJuIHtcbiAgICBzZWN0aW9uIChoZWFkaW5nLCByZWxhdGl2ZSA9IGZhbHNlKSB7XG4gICAgICBsZXQgbm9kZXMgPSBkb2N1bWVudC5ub2Rlcy5hdC5pZChzbHVnaWZ5KGhlYWRpbmcpKS5kZXNjZW5kYW50c1xuICAgICAgcmV0dXJuIGJ1aWxkSGVhZGluZ3NJbnRlcmZhY2UoZG9jdW1lbnQsIG5vZGVzKVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAqIEZvciBzcGVjaWFsbHkgbmFtZWQgc2VjdGlvbnMgd2hpY2ggaGF2ZSBhcnRpY2xlcyxcbiAgICAqIHdoYXQgYXJlIHRoZXkgY2FsbGVkPyB0aGlzIGlzIGEgY29udmVuaWVuY2UgbWV0aG9kIHNvXG4gICAgKiB3ZSBjYW4gZ2VuZXJhdGUgY3NzIGNsYXNzIG5hbWVzIHRvIG1ha2UgdGhlbSBlYXNpbHkgcXVlcnlhYmxlXG4gICAgKi9cbiAgICBhcnRpY2xlTmFtZUZvciAoc2VjdGlvbk5hbWUpIHtcbiAgICAgICAgaWYoZG9jdW1lbnQubW9kZWxEZWZpbml0aW9uICYmIGRvY3VtZW50Lm1vZGVsRGVmaW5pdGlvbi5zZWN0aW9uc0NvbmZpZyl7XG4gICAgICAgICAgICBsZXQgY2ZnID0gZG9jdW1lbnQubW9kZWxEZWZpbml0aW9uLnNlY3Rpb25zQ29uZmlnWyBzbHVnaWZ5KHNlY3Rpb25OYW1lKSBdXG5cbiAgICAgICAgICAgIGlmKGNmZyAmJiBjZmcuY29uZmlnLmFydGljbGVzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIE9iamVjdC52YWx1ZXMoY2ZnLmNvbmZpZy5hcnRpY2xlcylbMF1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBnZXQgdGl0bGVzICgpIHtcbiAgICAgIHJldHVybiB3cmFwUXVlcnlSZXNwb25zZShxdWVyeShoZWFkaW5nTm9kZXMsIHtkZXB0aDogdGl0bGVEZXB0aH0pKVxuICAgIH0sXG4gICAgZ2V0IHNlY3Rpb25zICgpIHtcbiAgICAgIHJldHVybiB3cmFwUXVlcnlSZXNwb25zZShxdWVyeShoZWFkaW5nTm9kZXMsIHtkZXB0aDogdGl0bGVEZXB0aCArIDF9KSlcbiAgICB9LFxuICAgIGdldCBhcnRpY2xlcyAoKSB7XG4gICAgICByZXR1cm4gd3JhcFF1ZXJ5UmVzcG9uc2UocXVlcnkoaGVhZGluZ05vZGVzLCB7ZGVwdGg6IHRpdGxlRGVwdGggKyAyfSkpXG4gICAgfSxcbiAgICBnZXQgbWlub3IgKCkge1xuICAgICAgbGV0IGRlcHRocyA9IFt0aXRsZURlcHRoICsgMywgdGl0bGVEZXB0aCArIDQsIHRpdGxlRGVwdGggKyA1XVxuICAgICAgcmV0dXJuIHdyYXBRdWVyeVJlc3BvbnNlKHF1ZXJ5KGhlYWRpbmdOb2Rlcywge2RlcHRoOiBkZXB0aHN9KSlcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gYnVpbGRDb2RlSW50ZXJmYWNlIChkb2N1bWVudCkge1xuICBsZXQgYmxvY2tzID0gbm9kZXNCeVR5cGUuY2FsbChkb2N1bWVudCwgJ2NvZGUnKVxuICByZXR1cm4gd3JhcENvZGVCbG9ja3MuY2FsbChkb2N1bWVudCwgYmxvY2tzKVxufVxuXG5mdW5jdGlvbiB3cmFwQ29kZUJsb2NrcyAoY29kZUJsb2Nrcykge1xuICBsZXQgZG9jdW1lbnQgPSB0aGlzXG5cbiAgbGV0IGkgPSB7XG4gICAgZ2V0IGxhbmd1YWdlcyAoKSB7XG4gICAgICByZXR1cm4gd3JhcFF1ZXJ5UmVzcG9uc2UoY29kZUJsb2NrcykucGx1Y2soJ2xhbmcnKS51bmlxdWUoKVxuICAgIH0sXG4gICAgZ2V0IGFsbCAoKSB7XG4gICAgICByZXR1cm4gd3JhcFF1ZXJ5UmVzcG9uc2UoY29kZUJsb2NrcylcbiAgICB9LFxuXG4gICAgZ2V0IGdyb3VwZWQgKCkge1xuICAgICAgcmV0dXJuIGNvZGVCbG9ja3MucmVkdWNlKChtZW1vLCBibG9jaykgPT4ge1xuICAgICAgICAobWVtb1tibG9jay5sYW5nXSA9IG1lbW9bYmxvY2subGFuZ10gfHwgW10pLnB1c2goYmxvY2spXG4gICAgICAgIHJldHVybiBtZW1vXG4gICAgICB9LCB7fSlcbiAgICB9LFxuXG4gICAgdW5kZXIgKGhlYWRpbmcsIHBhcmFtcyA9IHt9KSB7XG4gICAgICBsZXQgcmVzdWx0cyA9IGRvY3VtZW50Lm5vZGVzLmF0LmlkKHNsdWdpZnkoaGVhZGluZykpLmRlc2NlbmRhbnRzLmZpbHRlcihiID0+IGIudHlwZSA9PT0gJ2NvZGUnKVxuICAgICAgcmV0dXJuIHdyYXBRdWVyeVJlc3BvbnNlKHJlc3VsdHMsIHBhcmFtcylcbiAgICB9XG4gIH1cblxuICBjb2RlQmxvY2tzLm1hcChibG9jayA9PiBibG9jay5sYW5nKS5mb3JFYWNoKGxhbmcgPT4ge1xuICAgIGlmICghaVtsYW5nXSkge1xuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGksIGxhbmcsIHtcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgcmV0dXJuIHdyYXBRdWVyeVJlc3BvbnNlKGNvZGVCbG9ja3MsIHtsYW5nfSkgfHwgW11cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9XG4gIH0pXG5cbiAgcmV0dXJuIGlcbn1cblxuZnVuY3Rpb24gYnVpbGRGaWx0ZXJJbnRlcmZhY2UgKGRvY3VtZW50KSB7XG4gIGlmICghZG9jdW1lbnQuaW5kZXhlcykgeyBkb2N1bWVudC5pbmRleGVkIH1cblxuICBsZXQgdHlwZXMgPSBPYmplY3Qua2V5cyhkb2N1bWVudC5pbmRleGVzLnR5cGVzKVxuXG4gIGxldCBsaW5lcyA9IGRvY3VtZW50LmluZGV4ZXMubGluZXNcbiAgbGV0IGlkcyA9IGRvY3VtZW50LmluZGV4ZXMuaWRzXG5cbiAgbGV0IHR5cGVGaWx0ZXIgPSBub2Rlc0J5VHlwZS5iaW5kKGRvY3VtZW50KVxuXG4gIGxldCBmaW5kQnlJZCA9IGZ1bmN0aW9uIChpZCkge1xuICAgIHJldHVybiBkb2N1bWVudC5pbmRleGVkLmNoaWxkcmVuWyBpZHNbaWRdIF1cbiAgfVxuXG4gIGxldCBpID0ge1xuICAgIHF1ZXJ5OiBmdW5jdGlvbiAocGFyYW1zID0ge30pIHtcbiAgICAgIHJldHVybiBxdWVyeShkb2N1bWVudC5pbmRleGVkLmNoaWxkcmVuLCBwYXJhbXMpXG4gICAgfSxcbiAgICB1bmRlcjogZnVuY3Rpb24gKGhlYWRpbmcsIHBhcmFtcyA9IHt9KSB7XG4gICAgICBsZXQgcmVzdWx0cyA9IGRvY3VtZW50Lm5vZGVzLmF0LmlkKHNsdWdpZnkoaGVhZGluZykpLmRlc2NlbmRhbnRzXG4gICAgICByZXR1cm4gd3JhcFF1ZXJ5UmVzcG9uc2UocmVzdWx0cywgcGFyYW1zKVxuICAgIH0sXG4gICAgaW5jbHVkaW5nOiBmdW5jdGlvbiAoaGVhZGluZywgcGFyYW1zID0ge30pIHtcbiAgICAgIGxldCBoZWFkaW5nTm9kZSA9IGRvY3VtZW50Lm5vZGVzLmF0LmlkKHNsdWdpZnkoaGVhZGluZykpXG4gICAgICBsZXQgcmVzdWx0cyA9IFtoZWFkaW5nTm9kZV0uY29uY2F0KGRvY3VtZW50Lm5vZGVzLmF0LmlkKHNsdWdpZnkoaGVhZGluZykpLmRlc2NlbmRhbnRzKVxuXG4gICAgICByZXR1cm4gd3JhcFF1ZXJ5UmVzcG9uc2UocmVzdWx0cywgcGFyYW1zKVxuICAgIH0sXG4gICAgdHlwZTogdHlwZUZpbHRlci5iaW5kKGRvY3VtZW50KSxcbiAgICBvZjoge1xuICAgICAgdHlwZTogdHlwZUZpbHRlci5iaW5kKGRvY3VtZW50KVxuICAgIH0sXG4gICAgYXQ6IGFzc2lnbihmaW5kQnlJZCwge1xuICAgICAgbGluZTogKChpKSA9PiBkb2N1bWVudC5pbmRleGVkLmNoaWxkcmVuWyBsaW5lc1tpXSBdKSxcbiAgICAgIGluZGV4OiAoKGkpID0+IGRvY3VtZW50LmluZGV4ZWQuY2hpbGRyZW5baV0pLFxuICAgICAgaWQ6IGZpbmRCeUlkXG4gICAgfSlcbiAgfVxuXG4gIC8vIGRvY3VtZW50Lm5vZGVzLmhlYWRpbmdzXG4gIHR5cGVzLmZvckVhY2godHlwZSA9PiB7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGksIHR5cGUgKyAncycsIHtcbiAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiB0eXBlRmlsdGVyKHR5cGUpXG4gICAgICB9XG4gICAgfSlcbiAgfSlcblxuICByZXR1cm4gaVxufVxuXG5mdW5jdGlvbiBub2Rlc1VuZGVySGVhZGluZyAoaGVhZGluZywgcGFyYW1zKSB7XG4gIGxldCBub2RlcyA9IHRoaXMubm9kZXMuYXQuaWQoc2x1Z2lmeShoZWFkaW5nKSkuZGVzY2VuZGFudHNcbiAgcmV0dXJuIHdyYXBRdWVyeVJlc3BvbnNlKG5vZGUsIHBhcmFtcylcbn1cblxuXG5mdW5jdGlvbiBub2Rlc0J5VHlwZSAodHlwZSwgcGFyYW1zKSB7XG4gIGxldCBub2RlcyA9IHRoaXMuaW5kZXhlZC5jaGlsZHJlblxuICBsZXQgcmVzdWx0cyA9ICh0aGlzLmluZGV4ZXMudHlwZXNbdHlwZV0gfHwgW10pLm1hcChwb2ludGVyID0+IG5vZGVzW3BvaW50ZXJdKVxuICByZXR1cm4gd3JhcFF1ZXJ5UmVzcG9uc2UocmVzdWx0cywgcGFyYW1zKVxufVxuXG5mdW5jdGlvbiBxdWVyeU5vZGVzIChwYXJhbXMgPSB7fSkge1xuICBsZXQgbm9kZXMgPSBwYXJhbXMubm9kZXMgfHwgdGhpcy5pbmRleGVkLmNoaWxkcmVuXG4gIHJldHVybiB3cmFwUXVlcnlSZXNwb25zZShub2RlcywgcGFyYW1zKVxufVxuXG5mdW5jdGlvbiBxdWVyeSAobm9kZUxpc3QsIHBhcmFtcyA9IHt9KSB7XG4gIHJldHVybiBmaWx0ZXJRdWVyeShub2RlTGlzdCwgcGFyYW1zKVxufVxuXG5mdW5jdGlvbiBleHRyYWN0VGV4dCAobm9kZSkge1xuICBpZiAobm9kZS5jaGlsZHJlbiAmJiBub2RlLmNoaWxkcmVuWzBdKSB7XG4gICAgaWYgKG5vZGUuY2hpbGRyZW5bMF0gJiYgbm9kZS5jaGlsZHJlblswXS50eXBlID09PSAndGV4dCcgJiYgbm9kZS5jaGlsZHJlblswXS52YWx1ZSkge1xuICAgICAgcmV0dXJuIG5vZGUuY2hpbGRyZW5bMF0udmFsdWVcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gaXNSZWdleCAodmFsKSB7XG4gIGlmICh0eXBlb2YgKHZhbCk9PT0nb2JqZWN0JyAmJiBPYmplY3QuZ2V0UHJvdG90eXBlT2YodmFsKS50b1N0cmluZygpID09PSAnLyg/OikvJykge1xuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICByZXR1cm4gZmFsc2Vcbn1cblxuZnVuY3Rpb24gd3JhcFF1ZXJ5UmVzcG9uc2UgKHJlc3VsdHMsIHBhcmFtcykge1xuICBsZXQgcmVzcG9uc2UgPSBxdWVyeShyZXN1bHRzLCBwYXJhbXMpLnNvcnQoKGEsIGIpID0+IGEuaW5kZXggLSBiLmluZGV4KVxuXG4gIGFzc2lnbihyZXNwb25zZSwge1xuICAgIHF1ZXJ5IChwYXJhbXMpIHtcbiAgICAgIHJldHVybiB3cmFwUXVlcnlSZXNwb25zZShyZXNwb25zZSwgcGFyYW1zKVxuICAgIH0sXG4gICAgZ2V0IG1hcmtkb3duICgpIHtcbiAgICAgIHJldHVybiBmbGF0dGVuKHJlc3BvbnNlLm1hcChub2RlID0+IG5vZGUubGluZXMgJiYgbm9kZS5saW5lcy5yYXcpKS5qb2luKCdcXG4nKVxuICAgIH0sXG4gICAgZ2V0IHJhdyAoKSB7XG4gICAgICByZXR1cm4gZmxhdHRlbihyZXNwb25zZS5tYXAobm9kZSA9PiBub2RlLmxpbmVzICYmIG5vZGUubGluZXMucmF3KSlcbiAgICB9LFxuICAgIGdldCB0ZXh0ICgpIHtcbiAgICAgIHJldHVybiByZXNwb25zZS5tYXAobm9kZSA9PiBleHRyYWN0VGV4dChub2RlKSlcbiAgICB9LFxuICAgIGdldCBmaXJzdCgpIHtcbiAgICAgIHJldHVybiByZXNwb25zZVswXVxuICAgIH0sXG4gICAgZ2V0IGxhc3QoKXtcbiAgICAgIHJldHVybiByZXNwb25zZVsgcmVzcG9uc2UubGVuZ3RoIC0gMSBdXG4gICAgfVxuICB9KVxuXG4gIHJldHVybiByZXNwb25zZS5zb3J0KChhLGIpID0+IGEuaW5kZXggLSBiLmluZGV4KVxufVxuXG5mdW5jdGlvbiBuZXh0U2libGluZyAobm9kZSwgbm9kZXMsIGRlcHRoc0luZGV4LCBpZHNJbmRleCkge1xuICBsZXQgbXlJbmRleCA9IGRlcHRoc0luZGV4W25vZGUuZGVwdGhdLmluZGV4T2Yobm9kZS5pbmRleClcbiAgbGV0IG5leHRJbmRleCA9IGRlcHRoc0luZGV4W25vZGUuZGVwdGhdW215SW5kZXggKyAxXVxuICBpZiAobmV4dEluZGV4ICYmIG5vZGVzW25leHRJbmRleF0pIHtcbiAgICByZXR1cm4gbm9kZXNbbmV4dEluZGV4XVxuICB9XG59XG5cbmZ1bmN0aW9uIHByZXZpb3VzU2libGluZyAobm9kZSwgbm9kZXMsIGRlcHRoc0luZGV4LCBpZHNJbmRleCkge1xuICBsZXQgbXlJbmRleCA9IGRlcHRoc0luZGV4W25vZGUuZGVwdGhdLmluZGV4T2Yobm9kZS5pbmRleClcbiAgbGV0IG5leHRJbmRleCA9IGRlcHRoc0luZGV4W25vZGUuZGVwdGhdW215SW5kZXggLSAxXVxuICBpZiAobmV4dEluZGV4ID4gMCAmJiBuZXh0SW5kZXggJiYgbm9kZXNbbmV4dEluZGV4XSkge1xuICAgIHJldHVybiBub2Rlc1tuZXh0SW5kZXhdXG4gIH1cbn1cblxuZnVuY3Rpb24gYWxsQ2hpbGRyZW4gKG5vZGUsIG5vZGVzLCBpZHMsIGNoaWxkcmVuSW5kZXhlcykge1xuICBsZXQgaW5kZXhlcyA9IGNoaWxkcmVuSW5kZXhlc1tub2RlLmlkXVxuXG4gIGlmICghaW5kZXhlcykgeyByZXR1cm4gW10gfVxuXG4gIGxldCByZXN1bHRzID0gaW5kZXhlcy5tYXAoaSA9PiBub2Rlc1tpXSlcblxuICByZXR1cm4gcmVzdWx0cy5yZWR1Y2UoKG1lbW8sIGNoaWxkLCBpbmRleCkgPT4ge1xuICAgIGlmIChjaGlsZC50eXBlID09PSAnaGVhZGluZycpIHtcbiAgICAgIG1lbW8ucHVzaChjaGlsZClcbiAgICAgIG1lbW8gPSBtZW1vLmNvbmNhdChhbGxDaGlsZHJlbihjaGlsZCwgbm9kZXMsIGlkcywgY2hpbGRyZW5JbmRleGVzKS5zb3J0KChhLGIpPT5wYXJzZUludChhLmluZGV4KS1wYXJzZUludChiLmluZGV4KSkpXG4gICAgfSBlbHNlIHtcbiAgICAgIG1lbW8ucHVzaChjaGlsZClcbiAgICB9XG4gICAgcmV0dXJuIG1lbW9cbiAgfSwgW10pLnNvcnQoKGEsYikgPT4gcGFyc2VJbnQoYS5pbmRleCkgLSBwYXJzZUludChiLmluZGV4KSlcbn1cblxuZnVuY3Rpb24gZmlyc3RUeXBlSW50ZXJmYWNlIChub2RlKSB7XG4gIGxldCBvYmogPSB7fVxuXG4gIG5vZGUuZGVzY2VuZGFudHMuZm9yRWFjaChkZXNjZW5kYW50ID0+IHtcbiAgICBpZiAoIW9ialtkZXNjZW5kYW50LnR5cGVdKSB7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBkZXNjZW5kYW50LnR5cGUsIHtcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkgeyByZXR1cm4gZGVzY2VuZGFudCB9XG4gICAgICB9KVxuICAgIH1cbiAgfSlcblxuICByZXR1cm4gb2JqXG59XG5cbmZ1bmN0aW9uIGFwcGx5VG9Ob2RlIChub2RlLCBvcHRpb25zID0ge30pIHtcbiAgbGV0IHsgbm9kZXMsIGRvY3VtZW50IH0gPSBvcHRpb25zXG4gIGxldCB7IGlkcywgdHlwZXMsIGRlcHRocywgY2hpbGRyZW5JbmRleGVzIH0gPSBkb2N1bWVudC5pbmRleGVzXG5cbiAgbGF6eShub2RlLCAncGFyZW50JywgKCgpID0+IG5vZGVzWyBpZHNbbm9kZS5wYXJlbnRJZF0gXSApLCBmYWxzZSlcblxuICBoaWRlLmdldHRlcihub2RlLCAnZG9jdW1lbnQnLCAoKCkgPT4gZG9jdW1lbnQpKVxuXG4gIGxhenkobm9kZSwgJ2xpbmVzJywgZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB7XG4gICAgICBzdGFydDogbm9kZS5wb3NpdGlvbi5zdGFydC5saW5lLFxuICAgICAgZW5kOiBub2RlLnBvc2l0aW9uLmVuZC5saW5lLFxuICAgICAgZ2V0IHJhdyAoKSB7XG4gICAgICAgIGxldCBzdGFydCA9IG5vZGUucG9zaXRpb24uc3RhcnQubGluZVxuICAgICAgICBsZXQgZW5kID0gbm9kZS5wb3NpdGlvbi5lbmQubGluZVxuICAgICAgICByZXR1cm4gZG9jdW1lbnQubGluZXMuc2xpY2Uoc3RhcnQgLSAxLCBlbmQpXG4gICAgICB9XG4gICAgfVxuICB9LCBmYWxzZSlcblxuICBpZiAobm9kZS50eXBlID09PSAnaGVhZGluZycpIHtcbiAgICBoaWRlLnByb3BlcnR5KG5vZGUsICdzaWJsaW5ncycsIHt9KVxuXG4gICAgLy8gbm9kZS5zaWJsaW5ncy5uZXh0XG4gICAgbGF6eShub2RlLnNpYmxpbmdzLCAnbmV4dCcsICgoKSA9PiBuZXh0U2libGluZyhub2RlLCBub2RlcywgZGVwdGhzLCBpZHMpICksIGZhbHNlKVxuXG4gICAgLy8gbm9kZS5zaWJsaW5ncy5wcmV2aW91c1xuICAgIGxhenkobm9kZS5zaWJsaW5ncywgJ3ByZXZpb3VzJywgKCgpID0+IHByZXZpb3VzU2libGluZyhub2RlLCBub2RlcywgZGVwdGhzLCBpZHMpICksIGZhbHNlKVxuXG4gICAgbGF6eShub2RlLCAnZGVzY2VuZGFudHMnLCAoZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIGFsbENoaWxkcmVuKG5vZGUsIG5vZGVzLCBpZHMsIGNoaWxkcmVuSW5kZXhlcylcbiAgICB9KSwgZmFsc2UpXG5cbiAgICBsYXp5KG5vZGUsICdjaGlsZEhlYWRpbmdzJywgKGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBxdWVyeShub2RlLmRlc2NlbmRhbnRzLCB7dHlwZTonaGVhZGluZycsIGRlcHRoOiBub2RlLmRlcHRoICsgMX0pXG4gICAgfSkpXG5cbiAgICBsYXp5KG5vZGUsICdwYXJhZ3JhcGhzJywgKGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBxdWVyeShub2Rlcywge3R5cGU6J3BhcmFncmFwaCcsIHBhcmVudElkOiBub2RlLmlkfSlcbiAgICB9KSlcblxuICAgIGxhenkobm9kZSwgJ2NvZGVCbG9ja3MnLCAoZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIHF1ZXJ5KG5vZGVzLCB7dHlwZTonY29kZScsIHBhcmVudElkOiBub2RlLmlkfSlcbiAgICB9KSlcblxuICAgIGxhenkobm9kZSwgJ2ZpcnN0JywgKGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBmaXJzdFR5cGVJbnRlcmZhY2Uobm9kZSlcbiAgICB9KSwgZmFsc2UpXG5cbiAgICBhc3NpZ24obm9kZSwge1xuICAgICAgcXVlcnkgKC4uLnJlc3QpIHtcbiAgICAgICAgcmV0dXJuIHF1ZXJ5KG5vZGUuZGVzY2VuZGFudHMsIC4uLnJlc3QpXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG59XG5cbiJdfQ==